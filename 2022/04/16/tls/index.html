<!doctype html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="&lt;h3 id=&#34;å‰è¨€&#34;&gt;&lt;a href=&#34;#å‰è¨€&#34; class=&#34;headerlink&#34; title=&#34;å‰è¨€&#34;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;ä¸€ç›´æ²¡å­¦è¿‡è¿™ä¸ªï¼Œåœ¨å­¦ä¹ glibc2.34ä¸‹çš„emmaåˆ©ç”¨ä¸­æœ‰ä¸€ä¸ªç›¸å…³çš„èŠ‚ç‚¹ï¼Œåˆ©ç”¨largebin attackå°†fsï¼š0x30ä¸­çš„guardä¿®æ”¹ã€‚å…¶å®æˆ‘å¹¶ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿æ˜¯å•¥åªæ˜¯çœ‹è¿™wjhğŸ‘´çš„æ–‡ç« ä¸€ç‚¹ä¸€ç‚¹çš„å»å¤ç°ã€‚æ‰€ä»¥æ¥äº†è§£ä¸€ä¸‹ï¼Œemmmmï¼Œç†ç”±ååˆ†ç‰µå¼ºã€‚è¿™ç¯‡">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=yes">
  <title>Glibc TLSç»“åˆæºç çš„åˆ†æ | powercat</title>

  <link rel="stylesheet" id="chosen-theme" href="https://rawgit.com/fiatjaf/classless/master/themes/plain/theme.css">
  <script>
let link = document.getElementById('chosen-theme')
let widget = document.createElement('div')
widget.style.position = 'absolute'
widget.style.right = '5px'
widget.style.top = '2px'
widget.style.background = 'beige'
widget.style.color = '#444'
widget.style.zIndex = 99
widget.style.padding = '4px 8px'
widget.innerHTML = `
<label>
  <p>No theme was set on <code>theme_config</code>.<br>
     Choose a theme from the list to experiment with it:</p>
  <select></select>
</label>
`
fetch('https://api.github.com/repos/fiatjaf/classless/contents/themes')
  .then(r => r.json())
  .then(files => {
    document.body.appendChild(widget)
    let select = document.querySelector('select')
    files
      .filter(f => f.type === 'dir')
      .forEach(f => {
        let option = document.createElement('option')
        option.value = f.name
        option.innerHTML = f.name
        select.appendChild(option)
      })
    let options = Array.from(select.querySelectorAll('option'))
    let chosen = options[parseInt(Math.random() * options.length)]
    chosen.selected = true
    link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen.value}`)
    select.addEventListener('change', e => {
      let chosen = e.target.value
      link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen}`)
    })
  })
  .catch(console.log)
  </script>

<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <header role="banner">
      <a href="/">
        
          <img src="https://picsum.photos/640/480">
        
      </a>  
    <h1>
      <a href="/">powercat</a>
    </h1>
    <aside>
      <p></p>
    </aside>
  </header>
  
  <main>
    <article>
  <header>
  
  <h1><a href="http://example.com/2022/04/16/tls/">Glibc TLSç»“åˆæºç çš„åˆ†æ</a></h1>
  <aside>
    
    <time datetime="222022-04-16">
      April 16th 2022
    </time>
    
    <ul>
    
      <li><a href="/tags/study/">study</a></li>
    
    </ul>
  </aside>
</header>

  <div><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä¸€ç›´æ²¡å­¦è¿‡è¿™ä¸ªï¼Œåœ¨å­¦ä¹ glibc2.34ä¸‹çš„emmaåˆ©ç”¨ä¸­æœ‰ä¸€ä¸ªç›¸å…³çš„èŠ‚ç‚¹ï¼Œåˆ©ç”¨largebin attackå°†fsï¼š0x30ä¸­çš„guardä¿®æ”¹ã€‚å…¶å®æˆ‘å¹¶ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿æ˜¯å•¥åªæ˜¯çœ‹è¿™wjhğŸ‘´çš„æ–‡ç« ä¸€ç‚¹ä¸€ç‚¹çš„å»å¤ç°ã€‚æ‰€ä»¥æ¥äº†è§£ä¸€ä¸‹ï¼Œemmmmï¼Œç†ç”±ååˆ†ç‰µå¼ºã€‚è¿™ç¯‡åªæ˜¯ä¸€ä¸ªæ¦‚è¿°ï¼Œä¹‹åä¼šå¯¹TLSå®‰å…¨è¿›è¡Œä¸€ä¸ªæ›´è¯¦ç»†çš„åˆ†æï¼Œ</p>
<h3 id="TLSçš„ç®€å•ä»‹ç»"><a href="#TLSçš„ç®€å•ä»‹ç»" class="headerlink" title="TLSçš„ç®€å•ä»‹ç»"></a>TLSçš„ç®€å•ä»‹ç»</h3><p>TLSçš„å…¨ç§°ä¸ºThread Local Storageï¼Œæ˜¯ä¸€ç§çº¿ç¨‹ç‹¬å çš„æœ¬åœ°ç©ºé—´ï¼Œåœ¨TLSä¹‹å‰åªèƒ½ä½¿ç”¨pthread_getspecificä»¥åŠpthread_setspecificå‡½æ•°æ¥å­˜å‚¨çº¿ç¨‹çš„å‚¨å­˜ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡ä¸é«˜ï¼Œåœ¨TLSå‡ºç°ä¹‹åæˆ‘iä»¬å°±å¯ä»¥ç”¨__threadå…³é”®å­—æ¥å‘ŠçŸ¥ç¼–è¯‘å™¨æŸä¸€ä¸ªå˜é‡åº”å½“è¢«æ”¾åœ¨TLSï¼Œè€Œä¸”åªéœ€è¦å‡ æ¡æ±‡ç¼–æŒ‡ä»¤å°±å¯ä»¥è®¿é—®åˆ°å˜é‡ã€‚</p>
<h4 id="ç½‘ä¸Špiaoä¸€ä¸ªå¸ˆå‚…çš„å®ä¾‹"><a href="#ç½‘ä¸Špiaoä¸€ä¸ªå¸ˆå‚…çš„å®ä¾‹" class="headerlink" title="ç½‘ä¸Špiaoä¸€ä¸ªå¸ˆå‚…çš„å®ä¾‹"></a>ç½‘ä¸Špiaoä¸€ä¸ªå¸ˆå‚…çš„å®ä¾‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;pthread.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line">static __thread <span class="built_in">int</span> a = <span class="number">12345</span>; // <span class="number">0x3039</span></span><br><span class="line">__thread unsigned long long b = <span class="number">56789</span>; // <span class="number">0xddd5</span></span><br><span class="line">__thread <span class="built_in">int</span> c;</span><br><span class="line"></span><br><span class="line">void <span class="keyword">try</span>(void *tmp) &#123;</span><br><span class="line">    printf(<span class="string">&quot;try: a = %lx, b = %llx, c = %s\n&quot;</span>, a, b, &amp;c);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(void) &#123;</span><br><span class="line">    a = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    b = <span class="number">0xbadcaffe</span>;</span><br><span class="line">    c = <span class="number">0x61616161</span>;</span><br><span class="line">    printf(<span class="string">&quot;main thread: a = %lx, b = %llx, c = %s\n&quot;</span>, a, b, &amp;c);</span><br><span class="line">    pthread_t pid;</span><br><span class="line">    pthread_create(&amp;pid, NULL, <span class="keyword">try</span>, NULL);</span><br><span class="line">    pthread_join(pid, NULL);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨gcc tls.c -pthread -g -o tlsè¿›è¡Œç¼–è¯‘è¿è¡Œä»£ç </p>
<p>æˆ‘ä»¬å‘ç°è¿è¡Œä¹‹åçš„ç»“æœæ˜¯è¿™æ ·çš„</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220522193854-5tvj5a7.png" alt="image.png"></p>
<p>è¿™å°±ä½“ç°äº†TLSçš„å¼ºå¤§ä¹‹å¤„äº†ï¼Œ__threadè§£é‡Šä¹‹åè™½ç„¶abcæ˜¯å…¨å±€å˜é‡ï¼Œå¹¶ä¸”åœ¨mainå‡½æ•°å½“ä¸­è¿›è¡Œäº†æ•°å€¼çš„è¦†ç›–ï¼Œä½†æ˜¯åœ¨threadä¸­è¿˜æ˜¯åŸæ¥çš„æ•°å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬çŒœæµ‹threadæ˜¯åˆ©ç”¨å¦å¤–çš„ä¸€å¥—å­˜å‚¨æ•°æ®çš„ç»“æ„æ¥å®ç°çš„è¿™ç§çº¿ç¨‹ä¸Šçš„ç‹¬ç«‹ã€‚æˆ‘ä»¬åœ¨ç”¨gdbè°ƒè¯•ä¸€ä¸‹è¿™ä¸ªç¨‹åº</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220522200517-4buzrbz.png" alt="image.png"></p>
<p>æˆ‘ä»¬vmmapä¹‹åå‘ç°æ˜¯ç¨‹åºç»™tlsç•™å‡ºäº†ä¸€ä¸ªå¦å¤–çš„å­˜å‚¨æ•°æ®æ®µï¼ŒæŸ¥çœ‹æ•°æ®sectionçš„æ—¶å€™ç¨‹åºä¸­å¤šå‡ºäº†ä¸¤ä¸ªæ•°æ®æ®µ.todataã€.tbssè¿™ä¸¤ä¸ªæ•°æ®æ®µä¸­å­˜å‚¨çš„æ˜¯threadä¸­çš„æ•°æ®å°±æ˜¯æˆ‘ä»¬å£°æ˜çš„å…¨å±€å˜é‡TLSä¸­çš„abcã€‚æˆ‘ä»¬ç»§ç»­è¿è¡Œç¨‹åºçœ‹çœ‹ã€‚</p>
<p>æˆ‘ä»¬å‘ç°åœ¨tryä¸­çš„printfä¸­ä¼ å‚ä½¿ç”¨çš„åœ°å€æ˜¯fsçš„</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220522201233-uef546g.png" alt="image.png"></p>
<h4 id="Glibcçš„TLSå®ç°"><a href="#Glibcçš„TLSå®ç°" class="headerlink" title="Glibcçš„TLSå®ç°"></a>Glibcçš„TLSå®ç°</h4><p>å»å·´æ‹‰å·´æ‹‰æºç å§ï¼Œ</p>
<h5 id="éä¸»çº¿ç¨‹æƒ…å½¢"><a href="#éä¸»çº¿ç¨‹æƒ…å½¢" class="headerlink" title="éä¸»çº¿ç¨‹æƒ…å½¢"></a>éä¸»çº¿ç¨‹æƒ…å½¢</h5><h6 id="TCBç»“æ„ä½“ä»¥åŠstatic-TLSçš„ç©ºé—´åˆ†é…"><a href="#TCBç»“æ„ä½“ä»¥åŠstatic-TLSçš„ç©ºé—´åˆ†é…" class="headerlink" title="TCBç»“æ„ä½“ä»¥åŠstatic TLSçš„ç©ºé—´åˆ†é…"></a>TCBç»“æ„ä½“ä»¥åŠstatic TLSçš„ç©ºé—´åˆ†é…</h6><p>åœ¨å‡½æ•°pthread_create ä¸­å­˜åœ¨ä¸‹é¢ä¸€æ¡è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_create -&gt; ALLOC_STACK</span><br></pre></td></tr></table></figure>

<p>ALLOCATE_STACKå‡½æ•°é€šè¿‡ä¸‹é¢çš„æ“ä½œæ¥ä¸ºæ–°çº¿ç¨‹åˆ†é…æ ˆï¼š</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ–°æ ˆçš„åº•éƒ¨è¢«åˆ†é…äº†ä¸€ä¸ªå®¹çº³pdç»“æ„ä½“çš„ç©ºé—´ï¼Œè¯¥ç»“æ„ä½“çš„ç±»å‹ä¸ºstruct pthreadï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºä¸€ä¸ªthread descriptorï¼Œè¯¥ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªåŸŸè¢«ç§°ä¸ºtchhead_tç±»å‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mem = __mmap (<span class="literal">NULL</span>, size, (guardsize == <span class="number">0</span>) ? prot : PROT_NONE, MAP_PRIVATE  MAP_ANONYMOUS  MAP_STACK, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* ä½¿ç”¨mmapå‡½æ•°æ¥åˆ†é…ä¸€å—åŒ¿åæ˜ å°„æ¥ä½œä¸ºæˆ‘ä»¬çš„æ–°æ ˆ */</span></span><br><span class="line"><span class="comment">/* !!! omitted some code !!! */</span></span><br><span class="line"><span class="comment">/* å°†thread descriptorï¼ˆpdæŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“ï¼‰æ”¾åˆ°æ–°æ ˆçš„æ ˆåº• */</span></span><br><span class="line">pd = (<span class="keyword">struct</span> pthread *) ((((<span class="type">uintptr_t</span>) mem + size)</span><br><span class="line">            - TLS_TCB_SIZE)</span><br><span class="line">            &amp; ~__static_tls_align_m1);</span><br><span class="line"><span class="comment">/* è¿›è¡Œè¿™ä¸€æ­¥æ“ä½œåå†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *                                  TLS_TCB_SIZE</span></span><br><span class="line"><span class="comment"> *                                        ^</span></span><br><span class="line"><span class="comment"> *                            +-----------+----------+</span></span><br><span class="line"><span class="comment"> *                                                </span></span><br><span class="line"><span class="comment"> * ---------------------+----------------------------+</span></span><br><span class="line"><span class="comment"> *                                               </span></span><br><span class="line"><span class="comment"> *                       pad                     </span></span><br><span class="line"><span class="comment"> *                                               </span></span><br><span class="line"><span class="comment"> * ---------------------+----------------------------+</span></span><br><span class="line"><span class="comment"> *                            ^                      ^</span></span><br><span class="line"><span class="comment"> *                            +                      +</span></span><br><span class="line"><span class="comment"> *                           pd                mmap area end</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* !!! omitted some code !!! */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocate the DTV for this thread.  */</span></span><br><span class="line"><span class="keyword">if</span> (_dl_allocate_tls (TLS_TPADJ (pd)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Something went wrong.  */</span></span><br><span class="line">        assert (errno == ENOMEM);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Free the stack memory we just allocated.  */</span></span><br><span class="line">        (<span class="type">void</span>) __munmap (mem, size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> errno;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>tchhead_t</code>ç±»å‹ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>è¿™å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„TCBç»“æ„ä½“çš„å…·ä½“å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">               thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">void</span> *self;       <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> multiple_threads;</span><br><span class="line">  <span class="type">int</span> gscope_flag;</span><br><span class="line">  <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="type">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> vgetcpu_cache[<span class="number">2</span>];</span><br><span class="line">  <span class="comment">/* Bit 0: X86_FEATURE_1_IBT.</span></span><br><span class="line"><span class="comment">     Bit 1: X86_FEATURE_1_SHSTK.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> feature_1;</span><br><span class="line">  <span class="type">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_ss;</span><br><span class="line">  <span class="comment">/* The lowest address of shadow stack,  */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ssp_base;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((aligned (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure>

<h6 id="çˆ¶çº¿ç¨‹TCBçš„ç»§æ‰¿"><a href="#çˆ¶çº¿ç¨‹TCBçš„ç»§æ‰¿" class="headerlink" title="çˆ¶çº¿ç¨‹TCBçš„ç»§æ‰¿"></a>çˆ¶çº¿ç¨‹TCBçš„ç»§æ‰¿</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* Copy the stack guard canary.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREAD_COPY_STACK_GUARD</span></span><br><span class="line">  THREAD_COPY_STACK_GUARD (pd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Copy the pointer guard value.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREAD_COPY_POINTER_GUARD</span></span><br><span class="line">  THREAD_COPY_POINTER_GUARD (pd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>åœ¨æ ˆåˆ†é…ä¹‹åï¼Œæˆ‘ä»¬åœ¨pthreadå‡½æ•°ä¸­çœ‹åˆ°äº†ä¸Šé¢çš„ä»£ç ã€‚å°†å®å±•å¼€ä¹‹åå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Read member of the thread descriptor directly.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> THREAD_GETMEM(descr, member) \</span></span><br><span class="line"><span class="meta">  (&#123; __typeof (descr-&gt;member) __value;                        \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> (sizeof (__value) == 1)                           \</span></span><br><span class="line"><span class="meta">       asm volatile (<span class="string">&quot;movb %%fs:%P2,%b0&quot;</span>                      \</span></span><br><span class="line"><span class="meta">             : <span class="string">&quot;=q&quot;</span> (__value)                         \</span></span><br><span class="line"><span class="meta">             : <span class="string">&quot;0&quot;</span> (0), <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));     \</span></span><br><span class="line"><span class="meta">     <span class="keyword">else</span> <span class="keyword">if</span> (sizeof (__value) == 4)                          \</span></span><br><span class="line"><span class="meta">       asm volatile (<span class="string">&quot;movl %%fs:%P1,%0&quot;</span>                       \</span></span><br><span class="line"><span class="meta">             : <span class="string">&quot;=r&quot;</span> (__value)                         \</span></span><br><span class="line"><span class="meta">             : <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));          \</span></span><br><span class="line"><span class="meta">     <span class="keyword">else</span>                                     \</span></span><br><span class="line"><span class="meta">       &#123;                                      \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> (sizeof (__value) != 8)                       \</span></span><br><span class="line"><span class="meta">       <span class="comment">/* There should not be any value with a size other than 1,         \</span></span></span><br><span class="line"><span class="comment"><span class="meta">          4 or 8.  */</span>                             \</span></span><br><span class="line"><span class="meta">       abort ();                                  \</span></span><br><span class="line"><span class="meta">                                          \</span></span><br><span class="line"><span class="meta">     asm volatile (<span class="string">&quot;movq %%fs:%P1,%q0&quot;</span>                    \</span></span><br><span class="line"><span class="meta">               : <span class="string">&quot;=r&quot;</span> (__value)                       \</span></span><br><span class="line"><span class="meta">               : <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));        \</span></span><br><span class="line"><span class="meta">       &#125;                                      \</span></span><br><span class="line"><span class="meta">     __value; &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> THREAD_COPY_STACK_GUARD(descr) \</span></span><br><span class="line"><span class="meta">    ((descr)-&gt;header.stack_guard                          \</span></span><br><span class="line"><span class="meta">     = THREAD_GETMEM (THREAD_SELF, header.stack_guard))</span></span><br></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºï¼Œè¿™ä¸€æ®µçš„ä½œç”¨æ˜¯å°†çˆ¶è¿›ç¨‹çš„canaryå¤åˆ¶åˆ°å½“å‰è¿›ç¨‹çš„TCBç»“æ„ä½“ä¸­ã€‚äº‹å®ä¸Šï¼Œåœ¨fså¯„å­˜å™¨å°šæœªè¢«æ”¹å˜ä¹‹å‰ï¼Œå…¶ä¸­å­˜æ”¾ç€çˆ¶è¿›ç¨‹çš„TCBåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨THREAD_SELFå®æ¥è·å–çˆ¶çº¿ç¨‹çš„TCBæŒ‡é’ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> THREAD_SELF \</span></span><br><span class="line"><span class="meta">  (&#123; struct pthread *__self;                              \</span></span><br><span class="line"><span class="meta">     asm (<span class="string">&quot;mov %%fs:%c1,%0&quot;</span> : <span class="string">&quot;=r&quot;</span> (__self)                   \</span></span><br><span class="line"><span class="meta">      : <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, header.self)));            \</span></span><br><span class="line"><span class="meta">     __self;&#125;)</span></span><br></pre></td></tr></table></figure>

<h6 id="dtvå®ç°ç®€ä»‹"><a href="#dtvå®ç°ç®€ä»‹" class="headerlink" title="dtvå®ç°ç®€ä»‹"></a>dtvå®ç°ç®€ä»‹</h6><p>æˆ‘ä»¬æ²¿ç€è°ƒç”¨é“¾æ‰¾åˆ°äº†dtvæ•°ç»„ä»¥åŠTLS Blocksçš„å…·ä½“å®ç°ã€‚é¦–å…ˆæŸ¥çœ‹dtv_tç±»å‹çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dtv_pointer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">void</span> *val;                    <span class="comment">/* Pointer to data, or TLS_DTV_UNALLOCATED.  */</span></span><br><span class="line">  <span class="type">void</span> *to_free;                <span class="comment">/* Unaligned pointer, for deallocation.  */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Type for the dtv.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">dtv</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">size_t</span> counter;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dtv_pointer</span> <span class="title">pointer</span>;</span></span><br><span class="line">&#125; <span class="type">dtv_t</span>;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¯¥ç±»å‹æ˜¯ä¸€ä¸ªè”åˆï¼Œå…¶å€¼æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªcounterï¼Œè¯¥counteråœ¨dtv[-1]ä»¥åŠdtv[0]è¿™ä¸ªæˆå‘˜ä½¿ç”¨ï¼Œæ ‡å¿—dtvæ•°ç»„ä¸­çš„å…¥å£ä¸ªæ•°ï¼›å…¶å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªdtv_pointerç»“æ„ä½“ï¼Œå…¶ä¸­çš„æˆå‘˜æŒ‡å‘ä¸€ä¸ªTLS Blockã€‚</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220523092123-oo8ium1.png" alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>dtv</code>ä½¿ç”¨<code>module ID</code>ä½œä¸ºç´¢å¼•ï¼Œç¨‹åºè£…è½½çš„æ¯ä¸€ä¸ª<code>module</code>éƒ½ä¼šæœ‰ä¸€ä¸ª<code>module ID</code>ï¼Œè¿™ä¸ªå€¼å­˜åœ¨äºè¿™ä¸ª<code>module</code>å¯¹åº”çš„<code>link_map</code>ç»“æ„ä½“ä¸­ï¼Œè¯¥ç»“æ„ä½“ä¸­çš„ç›¸å…³æˆå‘˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* ä¸TLSæœ‰å…³çš„å†…å®¹  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* TLS segmentçš„èµ·å§‹åœ°å€ï¼ŒTLS segmentç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯tdataå’Œtbssï¼Œå­˜æ”¾åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</span></span><br><span class="line"><span class="comment">     * è¯¥segmentåœ¨moduleè¢«è£…è½½çš„æ—¶å€™æ˜ å°„çš„å†…å­˜ä¸­ï¼Œä½œä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆå§‹åŒ–TLS Blocksæ—¶çš„æ¨¡ç‰ˆ */</span></span><br><span class="line">    <span class="type">void</span> *l_tls_initimage;</span><br><span class="line">    <span class="comment">/* TLS segmentåœ¨æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆä»….tdataçš„å¤§å°ï¼‰  */</span></span><br><span class="line">    <span class="type">size_t</span> l_tls_initimage_size;</span><br><span class="line">    <span class="comment">/* TLS segmentåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼ˆ.dataåŠ ä¸Š.tbssçš„å¤§å°ï¼‰*/</span></span><br><span class="line">    <span class="type">size_t</span> l_tls_blocksize;</span><br><span class="line">    <span class="comment">/* TLS Blockçš„å¯¹é½æ ‡å‡†  */</span></span><br><span class="line">    <span class="type">size_t</span> l_tls_align;</span><br><span class="line">    <span class="comment">/* ç¬¦åˆå¯¹é½è¦æ±‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åç§»  */</span></span><br><span class="line">    <span class="type">size_t</span> l_tls_firstbyte_offset;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NO_TLS_OFFSET</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> NO_TLS_OFFSET  0</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FORCED_DYNAMIC_TLS_OFFSET</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> NO_TLS_OFFSET == 0</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> FORCED_DYNAMIC_TLS_OFFSET -1</span></span><br><span class="line"><span class="meta"># <span class="keyword">elif</span> NO_TLS_OFFSET == -1</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> FORCED_DYNAMIC_TLS_OFFSET -2</span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">error</span> <span class="string">&quot;FORCED_DYNAMIC_TLS_OFFSET is not defined&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">        <span class="comment">/* å¯¹äºç¨‹åºåŠ è½½æ—¶å°±è£…è½½äº†çš„æ¨¡å—ï¼Œè¯¥å˜é‡æ ‡ç¤ºæœ¬æ¨¡å—å¯¹åº”çš„TLS Blockåœ¨static TLSä¸­çš„åç§».  */</span></span><br><span class="line">    <span class="type">ptrdiff_t</span> l_tls_offset;</span><br><span class="line">    <span class="comment">/* æœ¬æ¨¡å—åœ¨dtvæ•°ç»„ä¸­çš„ç´¢å¼•  */</span></span><br><span class="line">    <span class="type">size_t</span> l_tls_modid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ç”±è¯¥åŠ¨æ€é“¾æ¥åº“æ„é€ çš„tlså˜é‡çš„æ•°é‡  */</span></span><br><span class="line">    <span class="type">size_t</span> l_tls_dtor_count;</span><br></pre></td></tr></table></figure>

<h6 id="dtvæ•°ç»„çš„ç©ºé—´åˆ†é…"><a href="#dtvæ•°ç»„çš„ç©ºé—´åˆ†é…" class="headerlink" title="dtvæ•°ç»„çš„ç©ºé—´åˆ†é…"></a>dtvæ•°ç»„çš„ç©ºé—´åˆ†é…</h6><p>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_create -&gt; ALLOC_STACK -&gt; _dl_allocate_tls -&gt; allocate_dtv -&gt;  _dl_allocate_tls_init</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºåœ¨<code>allocate_dtv</code>å‡½æ•°ä¸­ä¸ºdtvæ•°ç»„åˆ†é…ç©ºé—´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">allocate_dtv</span> <span class="params">(<span class="type">void</span> *result)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">size_t</span> dtv_length;</span><br><span class="line"></span><br><span class="line">  dtv_length = GL(dl_tls_max_dtv_idx) + DTV_SURPLUS;</span><br><span class="line">  dtv = <span class="built_in">calloc</span> (dtv_length + <span class="number">2</span>, <span class="keyword">sizeof</span> (<span class="type">dtv_t</span>));</span><br><span class="line">  <span class="keyword">if</span> (dtv != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* dtvé•¿åº¦çš„åˆå§‹å€¼ */</span></span><br><span class="line">      dtv[<span class="number">0</span>].counter = dtv_length;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* dtvçš„ä½™ä¸‹éƒ¨åˆ†è¢«åˆå§‹åŒ–ä¸º0ï¼Œæ¥è¡¨ç¤ºè¿™é‡Œä»€ä¹ˆä¹Ÿæ²¡æœ‰ */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* å°†dtvåŠ å…¥åˆ°çº¿ç¨‹æè¿°ç¬¦ä¸­ */</span></span><br><span class="line">      INSTALL_DTV (result, dtv);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”³è¯·äº†ä¸€å—åŒºåŸŸèµ‹å€¼ç»™dtvï¼Œç„¶ååˆ©ç”¨ä¸€äº›å®è¿›è¡Œä¸€æ³¢æ“ä½œï¼Œå°†å®å±•å¼€ä¹‹åæ˜¯è¿™æ ·çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">tcbhead_t</span> *) (result))-&gt;dtv = (dtv) + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡ŒTCBä¸­æŒ‡å‘çš„dtvæ•°ç»„çš„ç©ºé—´å·²ç»è¢«æˆåŠŸåˆ†é…ã€‚</p>
<h6 id="static-TLSä»¥åŠfsçš„åˆå§‹åŒ–"><a href="#static-TLSä»¥åŠfsçš„åˆå§‹åŒ–" class="headerlink" title="static TLSä»¥åŠfsçš„åˆå§‹åŒ–"></a>static TLSä»¥åŠfsçš„åˆå§‹åŒ–</h6><p> ä¸‹é¢æˆ‘ä»¬æ¥çœ‹<code>_dl_allocate_tls_init</code>å‡½æ•°ä¸­è¿›è¡Œçš„åˆå§‹åŒ–å·¥ä½œï¼š ä»å®è§‚ä¸Šæ¥è¯´ï¼Œè¯¥å‡½æ•°è¿›è¡Œäº†ä¸€æ¬¡å¯¹link_mapçš„éå†ï¼Œå¹¶ä¸”å¯¹äºlink_mapé“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¯¹åº”ä¸€ä¸ªæ¨¡å—ï¼‰éƒ½è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* resultæŒ‡é’ˆæŒ‡å‘TCBç»“æ„ä½“ï¼Œ mapä¸ºlink mapçš„ä¸€ä¸ªèŠ‚ç‚¹ */</span></span><br><span class="line">dest = (<span class="type">char</span> *) result - <span class="built_in">map</span>-&gt;l_tls_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®DTV entryï¼Œä¸€äº›å¹³å°åœ¨é™æ€é“¾æ¥çš„ç¨‹åºä¸­ä½¿ç”¨çš„ç®€åŒ–ç‰ˆçš„__tls_get_addréœ€è¦è¿™ä¸ªå€¼ */</span></span><br><span class="line">dtv[<span class="built_in">map</span>-&gt;l_tls_modid].pointer.val = dest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¤åˆ¶åˆå§‹é•œåƒï¼Œå¹¶å°†bssæ®µæ¸…é›¶  */</span></span><br><span class="line"><span class="built_in">memset</span> (__mempcpy (dest, <span class="built_in">map</span>-&gt;l_tls_initimage,</span><br><span class="line">            <span class="built_in">map</span>-&gt;l_tls_initimage_size), <span class="string">&#x27;\0&#x27;</span>,</span><br><span class="line">                <span class="built_in">map</span>-&gt;l_tls_blocksize - <span class="built_in">map</span>-&gt;l_tls_initimage_size);</span><br></pre></td></tr></table></figure>

<p>å¯¹æ¯ä¸€ä¸ªmoduleè¿›è¡Œè¿™ä¸€æ­¥æ“ä½œåï¼Œï¼ˆä¸è€ƒè™‘dlopenï¼Œdlfreeï¼‰æˆ‘ä»¬çš„TLSå·²ç»è¢«åˆå§‹åŒ–å®Œæˆäº†ã€‚è¿™æ—¶æˆ‘ä»¬è¿˜ç•™æœ‰æœ€åä¸€ä¸ªç–‘é—®ï¼šè°è®¾ç½®äº†fså¯„å­˜å™¨ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼Œfså¯„å­˜å™¨æ˜¯ç”¨æˆ·æ€ç¨‹åºæ— æ³•è®¾ç½®ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè®¾ç½®ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨<code>strace -f ./tls</code>å‘½ä»¤æ¥è·Ÿè¸ªç¨‹åºæ‰§è¡Œä¸­çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æˆ‘ä»¬æ‰€æ–™ï¼Œæˆ‘ä»¬åœ¨cloneç³»ç»Ÿè°ƒç”¨ä¸­å‘ç°äº†å¦‚ä¸‹å‚æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clone(child_stack=<span class="number">0x7fa882eeffb0</span>, flags=CLONE_VMCLONE_FSCLONE_FILESCLONE_SIGHANDCLONE_THREADCLONE_SYSVSEMCLONE_SETTLSCLONE_PARENT_SETTIDCLONE_CHILD_CLEARTID, parent_tid=[<span class="number">37577</span>], tls=<span class="number">0x7fa882ef0700</span>, child_tidptr=<span class="number">0x7fa882ef09d0</span>) = <span class="number">37577</span></span><br></pre></td></tr></table></figure>

<p>è¿›è€ŒæŸ¥æ‰¾glibcä¸­<code>pthread_create</code>å‡½æ•°å¯¹cloneçš„è°ƒç”¨ï¼Œæˆ‘ä»¬æ‰¾åˆ°å¦‚ä¸‹è°ƒç”¨é“¾åœ¨TCBè¢«è®¾ç½®ä¹‹åå®Œæˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_create -&gt; create_thread -&gt; clone syscall</span><br></pre></td></tr></table></figure>

<p>cloneå¤„çš„ä»£ç ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="type">const</span> <span class="type">int</span> clone_flags = (CLONE_VM  CLONE_FS  CLONE_FILES  CLONE_SYSVSEM</span><br><span class="line">              CLONE_SIGHAND  CLONE_THREAD</span><br><span class="line">              CLONE_SETTLS  CLONE_PARENT_SETTID</span><br><span class="line">              CLONE_CHILD_CLEARTID</span><br><span class="line">              <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">TLS_DEFINE_INIT_TP (tp, pd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (ARCH_CLONE (&amp;start_thread, STACK_VARIABLES_ARGS,</span><br><span class="line">                  clone_flags, pd, &amp;pd-&gt;tid, tp, &amp;pd-&gt;tid)</span><br><span class="line">          == <span class="number">-1</span>))</span><br><span class="line">  <span class="keyword">return</span> errno;</span><br></pre></td></tr></table></figure>

<p>æœ‰è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clone -&gt; _do_fork -&gt; copy_process -&gt; copy_thread_tls -&gt; do_arch_prctl_64</span><br></pre></td></tr></table></figure>

<h3 id="TLSå®‰å…¨æœºåˆ¶"><a href="#TLSå®‰å…¨æœºåˆ¶" class="headerlink" title="TLSå®‰å…¨æœºåˆ¶"></a>TLSå®‰å…¨æœºåˆ¶</h3><h4 id="stack-canary"><a href="#stack-canary" class="headerlink" title="stack canary"></a>stack canary</h4><p>æˆ‘ä»¬ç†Ÿæ‚‰çš„canaryæœºåˆ¶å°±æ˜¯æºäºè¿™é‡Œï¼Œæˆ‘ä»¬åœ¨åšé¢˜çš„æ—¶å€™æŸ¥çœ‹æ±‡ç¼–ä¼šå‘ç°æˆ‘ä»¬æŸ¥çœ‹stackçš„æ—¶å€™æ˜¯å–ç”¨çš„fs:0x28ä¸­çš„å†…å®¹ã€‚</p>
<h4 id="pointer-guard"><a href="#pointer-guard" class="headerlink" title="pointer guard"></a>pointer guard</h4><p>è¿™ç§ä¸œè¥¿å°±æ˜¯æˆ‘å­¦ä¹ TLSçš„ç›®çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬ç»å¸¸ä¼šå¿½ç•¥çš„ä¸€ä¸ªä¿æŠ¤æœºåˆ¶ï¼Œå…ˆçœ‹ä¸€ä¸‹ç›¸å…³å®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  <span class="keyword">define</span> PTR_MANGLE(var)   asm (<span class="string">&quot;xor %%fs:%c2, %0\n&quot;</span>             \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;rol $2*&quot;</span> LP_SIZE <span class="string">&quot;+1, %0&quot;</span>           \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;=r&quot;</span> (var)                 \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;0&quot;</span> (var),                 \</span></span><br><span class="line"><span class="meta">                       <span class="string">&quot;i&quot;</span> (offsetof (tcbhead_t,          \</span></span><br><span class="line"><span class="meta">                              pointer_guard)))</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> PTR_DEMANGLE(var) asm (<span class="string">&quot;ror $2*&quot;</span> LP_SIZE <span class="string">&quot;+1, %0\n&quot;</span>         \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;xor %%fs:%c2, %0&quot;</span>               \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;=r&quot;</span> (var)                 \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;0&quot;</span> (var),                 \</span></span><br><span class="line"><span class="meta">                       <span class="string">&quot;i&quot;</span> (offsetof (tcbhead_t,          \</span></span><br><span class="line"><span class="meta">                              pointer_guard)))</span></span><br><span class="line"><span class="comment">// 64ä½æƒ…å†µä¸‹ï¼ŒLP_SIZEä¸º0x10</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªå®åˆ©ç”¨<code>pointer_guard</code>åˆ†åˆ«å¯¹æŒ‡é’ˆè¿›è¡Œäº†åŠ å¯†å’Œè§£å¯†æ“ä½œï¼ŒåŠ å¯†ç”±ä¸€æ¬¡å¼‚æˆ–ä»¥åŠä¸€æ¬¡bitwise rotateç»„æˆã€‚åŠ å¯†ä½¿ç”¨çš„keyæ¥è‡ª<code>fs:[offsetof(tcbhead_t, pointer_guard)]</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹åŠ å¯†å’Œè§£å¯†çš„è„†å¼±æ€§è¿›è¡Œè§£æã€‚ åˆ©ç”¨<code>pointer_guard</code>è¿›è¡ŒåŠ å¯†çš„è¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸º<code>rol(ptr ^ pointer_guard, 0x11, 64)</code>ï¼Œè§£å¯†çš„è¿‡ç¨‹ä¸º<code>ror(enc, 0x11, 64) ^ pointer_guard</code>ã€‚é‚£ä¹ˆå‡è®¾ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†encå’Œpträ¸¤ä¸ªå€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªç®—å¼æ¥è®¡ç®—å‡º<code>pointer_guard</code>(64ä½æƒ…å†µ)ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pointer_guard = ror (enc, <span class="number">0x11</span>, <span class="number">64</span>) ^ ptr </span><br></pre></td></tr></table></figure>

<p>åŒæ—¶å‡è®¾æˆ‘ä»¬è·å¾—äº†å¯¹<code>pointer_guard</code>çš„ä»»æ„å†™ï¼Œå¹¶ä¸”å·²çŸ¥ä¼šè°ƒç”¨ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ<code>enc</code>ï¼Œä»¥åŠæ¶æ„åœ°å€<code>evil_ptr</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹<code>pointer_guard</code>ä¸º<code>evil_guard</code>æ¥å°†è§£å¯†åçš„æŒ‡é’ˆå¯¼å‘æ¶æ„åœ°å€ï¼Œè½¬æ¢å…³ç³»å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil_guard = ror (enc, <span class="number">0x11</span>, <span class="number">64</span>) ^ evil_ptr</span><br></pre></td></tr></table></figure>

<h3 id="TLSçš„ç›¸å…³æ”»å‡»"><a href="#TLSçš„ç›¸å…³æ”»å‡»" class="headerlink" title="TLSçš„ç›¸å…³æ”»å‡»"></a>TLSçš„ç›¸å…³æ”»å‡»</h3><h4 id="TLSè¯»å†™æ–¹æ³•ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¸ˆå‚…å°è¯•çš„"><a href="#TLSè¯»å†™æ–¹æ³•ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¸ˆå‚…å°è¯•çš„" class="headerlink" title="TLSè¯»å†™æ–¹æ³•ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¸ˆå‚…å°è¯•çš„"></a>TLSè¯»å†™æ–¹æ³•ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¸ˆå‚…å°è¯•çš„</h4><ul>
<li><p>ä¸»çº¿ç¨‹æƒ…å½¢</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> åœ¨libcåœ°å€å·²ç»æ³„éœ²çš„æƒ…å†µä¸‹å¯¹libcåœ°å€åŠ ä¸ŠæŸä¸ªç‰¹å®šçš„åç§»ï¼Œåˆ©ç”¨ä»»æ„åœ°å€è¯»å†™ç›´æ¥æ“ä½œTCBç»“æ„ï¼ˆè¿™é‡Œæˆ‘ä»¬å‡å®šlibcä¸TLSä¹‹é—´çš„åç§»æ˜¯å›ºå®šçš„ï¼‰</li>
<li><input disabled="" type="checkbox"> é€šè¿‡æ ˆæ³„éœ²<code>pointer_guard</code>ä»¥åŠ<code>canary</code>(é€šå¸¸é€‚ç”¨äºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ”»å‡»ï¼Œæ ¹æ®cnitlrtå¸ˆå‚…æä¾›çš„æ€è·¯ï¼Œåœ¨å †é¢˜ä¸­å¯ä»¥å°†<code>__free_hook</code>åŠ«æŒä¸º<code>printf</code>å‡½æ•°ï¼Œæ³¨æ„å‰é¢è¯´è¿‡ï¼Œè¿™ä¸¤ç»„æ•°æ®åœ¨æ ˆä¸­å­˜åœ¨ä¸€ä»½å‰¯æœ¬ï¼Œå¹¶ä¸”Auxiliary Vectorä¸­å­˜åœ¨æŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆï¼‰)</li>
<li><input checked="" disabled="" type="checkbox"> é€šè¿‡æ³„éœ²libcä¸­å·²ç»åˆ©ç”¨<code>pointer_guard</code>åŠ å¯†è¿‡çš„å‡½æ•°åœ°å€ï¼ˆå¦‚<code>_dl_fini</code>ï¼Œå…¶åŠ å¯†åçš„åœ°å€åœ¨<code>__exit_funcs</code>æ•°ç»„ä¸­ï¼ŒçœŸå®çš„åœ°å€å¯ä»¥ç”¨libcåŸºåœ°å€è®¡ç®—å¾—åˆ°ï¼‰ï¼Œç„¶ååˆ©ç”¨çœŸå®åœ°å€è¿›è¡Œé€†è¿ç®—è§£å‡º<code>pointer_guard</code></li>
<li><input disabled="" type="checkbox"> ä¿®æ”¹<code>global_max_fast</code>ç„¶åé€šè¿‡freeä¸€ä¸ªè¾ƒå¤§çš„chunkæ¥å°†è¯¥chunkçš„åœ°å€å†™å…¥åˆ°canaryæˆ–è€…<code>pointer_guard</code>ä¸­ï¼‰ã€‚</li>
</ul>
</li>
<li><p>éä¸»çº¿ç¨‹æƒ…å½¢ï¼š</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> å› ä¸ºè¿™æ—¶TCBç»“æ„ä½“ä¹Ÿåœ¨æ ˆä¸Šã€‚å¯¹äºä¸€ä¸ªè¶³å¤Ÿé•¿çš„æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“è¦†ç›–<code>tack_guard</code>ä»¥åŠ<code>pointer_guard</code>ã€‚æ³¨æ„static TLSåœ¨æ­¤ç§æƒ…å†µä¸‹æ˜¯ä½äºTCBç»“æ„ä½“ä¹‹å‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åŒæ—¶è¦†ç›–ä¸€äº›TLSå˜é‡ã€‚åé¢æˆ‘ä»¬ä¼šç»™å‡ºå…·ä½“çš„ä¾‹å­æ¥ä»‹ç»è¿™ç§åˆ©ç”¨æ–¹å¼ã€‚</li>
</ul>
</li>
</ul>
<h4 id="å…·ä½“æ”»å‡»è·¯å¾„"><a href="#å…·ä½“æ”»å‡»è·¯å¾„" class="headerlink" title="å…·ä½“æ”»å‡»è·¯å¾„"></a>å…·ä½“æ”»å‡»è·¯å¾„</h4><ol>
<li>ç”±äº<code>tcache</code>æ˜¯ä¸€ä¸ªTLSå˜é‡ï¼Œä¸”è¯¥å˜é‡æ²¡æœ‰ä»»ä½•ä¿æŠ¤ï¼Œå¯ä»¥å†™<code>tcache</code>æ¥åŠ«æŒæ•´ä¸ªtcacheé“¾è¡¨ã€‚</li>
<li>æ³„éœ²<code>pointer_guard</code>åå¯ä»¥åŠ«æŒexitå‡½æ•°çš„æµç¨‹ï¼Œå¯ä»¥åŠ«æŒ<code>__exit_funcs</code>æ•°ç»„æ¥æ‰§è¡Œå‡½æ•°åˆ—è¡¨ï¼Œä½†è¿™ç§æ–¹æ³•åªèƒ½æ§åˆ¶ä¸€ä¸ªå‡½æ•°å‚æ•°ã€‚</li>
<li>åŒæ ·æ˜¯æ³„éœ²<code>pointer_guard</code>ï¼Œä½†ä¹‹åå¯ä»¥åŠ«æŒ<code>tls_dtor_list</code>ï¼ˆä¸»çº¿ç¨‹æƒ…å½¢éœ€è¦ä»»æ„åœ°å€å†™ï¼Œéä¸»çº¿ç¨‹éœ€è¦ä»»æ„åœ°å€å†™æˆ–è€…æ ˆæº¢å‡ºï¼‰ï¼Œè¿›è€Œæ„é€ <code>dtor_list</code>ç»“æ„ä½“æ§åˆ¶<code>rdi</code>ï¼ˆ<code>obj</code>åŸŸï¼‰å’Œ<code>rdx</code>ï¼ˆ<code>next</code>åŸŸï¼‰ï¼Œè¿›è€Œåˆ©ç”¨<code>setcontext+53</code>æ¥è¿›è¡ŒSROPã€‚ <strong>æ­¤æ–¹æ³•é€‚ç”¨äºç›®å‰æ‰€æœ‰ä¸»æµlibcç‰ˆæœ¬</strong> ã€‚</li>
<li>åœ¨ä»»æ„åœ°å€å†™æƒ…å†µä¸‹ï¼Œå¦‚æœå·²çŸ¥ä¸€ä¸ªç¡®åˆ‡çš„åˆ©ç”¨<code>pointer_guard</code>è§£å¯†æŒ‡é’ˆçš„ä½ç½®ï¼ˆå¦‚<code>printf</code>å‡½æ•°ä¸­å°±å­˜åœ¨è¿™æ ·çš„è°ƒç”¨ï¼‰ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹<code>pointer_guard</code>æ¥ä½¿è§£å¯†åçš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘<code>one_gadget</code>ï¼Œè¿›è€Œgetshellã€‚</li>
<li>æ³„éœ²æˆ–å†™å…¥<code>stack_canary</code>æ¥ç»•è¿‡<code>canary</code>æœºåˆ¶ï¼ˆæ³¨æ„ä¸»çº¿ç¨‹çš„<code>stack_canary</code>å’Œå­çº¿ç¨‹çš„ä¸€æ ·ï¼Œå¹¶ä¸”ä¿®æ”¹ä¸»çº¿ç¨‹çš„<code>stack_canary</code>ä¹‹ååˆ›å»ºçš„å­çº¿ç¨‹çš„<code>canary</code>ä¹Ÿä¼šè¢«ä¿®æ”¹ï¼‰</li>
</ol>
</div>
</article>

  </main>
  <aside>
    <p>This is an `aside`, a useful place to put information of any kind: metadata about the site author (with or without pictures), brief information about the purposes of the site, a static collection of external links or anything else.</p>
<p>For some Classless themes pictures and data about the author may suit better in the `cover` and `description` site attributes (see `config.toml`), but most of the times that kind of information will fit here better.</p>

  </aside>
  <footer role="contentinfo">
    <p>A default site footer. If you don't know what to place here maybe you should just write your name plus the current year?</p>
<p>If you want to have a sitemap, a contact form or other complex stuff, most Classless themes will also handle it nicely. Or you can take a look at the <code>aside.html</code> partial.</p>

  </footer>
</body>
